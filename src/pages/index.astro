---
/*
 * ============================================================================
 * FEATURE INDEX - src/pages/index.astro
 * ============================================================================
 *
 * FRONTMATTER (Lines 1-23)
 * â””â”€ Imports and variables
 *
 * STYLES (Lines 24-1759)
 * â”œâ”€ Theme Variables (Line 25)
 * â”œâ”€ Theme Icon Visibility (Line 66)
 * â”œâ”€ Reset and Base Styles (Line 83)
 * â”œâ”€ Theme Transition Background (Line 108)
 * â”œâ”€ Header Styles (Line 137)
 * â”‚  â”œâ”€ Fixed Seamless Header (Line 137)
 * â”‚  â”œâ”€ Header Controls (Line 182)
 * â”‚  â”œâ”€ Instagram Link (Line 191)
 * â”‚  â”œâ”€ Theme Toggle (Line 210)
 * â”‚  â””â”€ Shuffle Button (Line 238)
 * â”œâ”€ SVG Transformations (Line 265)
 * â”œâ”€ Theme Toggle Animations (Line 279)
 * â”œâ”€ Bubble Animations (Line 334)
 * â”œâ”€ Main Content (Line 468)
 * â”œâ”€ Masonry Gallery Layout (Line 478)
 * â”œâ”€ Image Overlay (Line 569)
 * â”œâ”€ Filter Banner (Line 596)
 * â”œâ”€ Lightbox (Line 649)
 * â”œâ”€ Location Manager Modal (Line 854)
 * â”œâ”€ Navigation Arrows (Line 1099)
 * â”œâ”€ Responsive Design (Line 1144)
 * â”œâ”€ Loading Animation (Line 1539)
 * â”œâ”€ Hidden Class (Line 1555)
 * â”œâ”€ Focus States (Line 1560)
 * â”œâ”€ Location and Time Display (Line 1571)
 * â”œâ”€ Mobile Header Layout (Line 1603)
 * â”œâ”€ Copyright Footer (Line 1694)
 * â””â”€ Performance Optimizations (Line 1723)
 *
 * HTML (Lines 1760-2016)
 * â”œâ”€ Theme Transition Overlay (Line 1775)
 * â”œâ”€ Header (Line 1779)
 * â”‚  â”œâ”€ Location/Time Display (Line 1781)
 * â”‚  â”œâ”€ Logo (Line 1785)
 * â”‚  â””â”€ Header Controls (Line 1786)
 * â”œâ”€ Main Content (Line 1823)
 * â”‚  â”œâ”€ Filter Banner (Line 1824)
 * â”‚  â””â”€ Gallery Grid (Line 1848)
 * â”œâ”€ Lightbox (Line 1871)
 * â”‚  â”œâ”€ Main Image (Line 1872)
 * â”‚  â”œâ”€ Sidebar (Line 1878)
 * â”‚  â””â”€ Navigation Arrows (Line 1951)
 * â”œâ”€ Location Manager Modal (Line 1967)
 * â””â”€ Gallery Data Script (Line 2001)
 *
 * SCRIPTS (Lines 2017-3990)
 * â”œâ”€ Logging Utilities (Line 2018)
 * â”œâ”€ Theme Initialization (Line 2030)
 * â”œâ”€ DOMContentLoaded Handler (Line 2127)
 * â”‚  â”œâ”€ Gallery Data Loading (Line 2128)
 * â”‚  â”œâ”€ Progressive Image Loading (Line 2134)
 * â”‚  â”œâ”€ Image Error Handling (Line 2180)
 * â”‚  â”œâ”€ Category Filtering (Line 2262)
 * â”‚  â”œâ”€ Lightbox Functionality (Line 2421)
 * â”‚  â”œâ”€ Keyboard Navigation (Line 2784)
 * â”‚  â”œâ”€ Location Manager (Line 2894)
 * â”‚  â”œâ”€ Shuffle Functionality (Line 3198)
 * â”‚  â”œâ”€ Clock Display (Line 3534)
 * â”‚  â””â”€ Animations (Line 3592)
 * â””â”€ Page Transition Handler (Line 3897)
 *
 * ============================================================================
 */

import Layout from '../layouts/Layout.astro';
import { galleryItems as importedGalleryItems, categories } from '../data/gallery';

const title = "Shreyan Sengupta";
const currentYear = new Date().getFullYear();

// In development mode, prioritize photos with missing data for easy editing
let galleryItems = [...importedGalleryItems];
if (import.meta.env.DEV) {
  galleryItems.sort((a, b) => {
    // Helper to check if location is missing or empty
    const hasMissingLocation = (item: any) => {
      return !item.metadata?.location ||
             item.metadata.location === '' ||
             item.metadata.location === '----' ||
             item.metadata.location === 'Unknown';
    };

    // Helper to check if lens is missing or empty
    const hasMissingLens = (item: any) => {
      return !item.metadata?.lens ||
             item.metadata.lens === '' ||
             item.metadata.lens === '----' ||
             item.metadata.lens === 'Unknown';
    };

    const aMissingLocation = hasMissingLocation(a);
    const bMissingLocation = hasMissingLocation(b);
    const aMissingLens = hasMissingLens(a);
    const bMissingLens = hasMissingLens(b);

    // Priority 1: Photos missing location data come first
    if (aMissingLocation && !bMissingLocation) return -1;
    if (!aMissingLocation && bMissingLocation) return 1;

    // Priority 2: Among photos with location data (or both missing location),
    // prioritize those missing lens data
    if (!aMissingLocation && !bMissingLocation) {
      if (aMissingLens && !bMissingLens) return -1;
      if (!aMissingLens && bMissingLens) return 1;
    }

    // Keep original order for items with the same priority
    return 0;
  });

  console.log('ðŸ”§ DEV MODE: Photos sorted to show missing data first');
  console.log(`   - Photos missing location: ${galleryItems.filter((item: any) =>
    !item.metadata?.location ||
    item.metadata.location === '' ||
    item.metadata.location === '----' ||
    item.metadata.location === 'Unknown'
  ).length}`);
  console.log(`   - Photos missing lens: ${galleryItems.filter((item: any) =>
    !item.metadata?.lens ||
    item.metadata.lens === '' ||
    item.metadata.lens === '----' ||
    item.metadata.lens === 'Unknown'
  ).length}`);
}
---

<Layout title={title}>
  <style is:global>
    /* Theme Variables - Dark Mode Default */
    :root {
      --bg-primary: #000000;
      --bg-secondary: #000000;
      --text-primary: #ffffff;
      --text-secondary: #cccccc;
      --border-color: #1a1a1a;
      --card-bg: #000000;
      --card-border: #1a1a1a;
      --overlay-bg: rgba(0, 0, 0, 0.85);
      --filter-bg: rgba(0, 0, 0, 0.2);
      --filter-border: rgba(255, 255, 255, 0.08);
      --filter-hover-bg: rgba(0, 0, 0, 0.35);
      --shadow: rgba(0, 0, 0, 0.3);
      --lightbox-bg: rgba(0, 0, 0, 0.98);
      --lightbox-sidebar: #000000;
      --filter-text: #ffffff;
      --filter-text-secondary: #ffffff;
      --filter-active-bg: #ffffff;
      --filter-active-text: #000000;
    }

    /* Light Mode Overrides */
    :root.light-theme {
      --bg-primary: #ffffff;
      --bg-secondary: #ffffff;
      --text-primary: #000000;
      --text-secondary: #333333;
      --border-color: #e0e0e0;
      --card-bg: #ffffff;
      --card-border: #e0e0e0;
      --filter-bg: rgba(255, 255, 255, 0.15);
      --filter-border: rgba(0, 0, 0, 0.08);
      --filter-hover-bg: rgba(255, 255, 255, 0.25);
      --shadow: rgba(0, 0, 0, 0.12);
      --lightbox-bg: rgba(255, 255, 255, 0.98);
      --lightbox-sidebar: #ffffff;
      --filter-active-bg: #000000;
      --filter-active-text: #ffffff;
    }

    /* Theme icon visibility */
    .light-icon {
      display: block;
    }

    .dark-icon {
      display: none;
    }

    :root.light-theme .dark-icon {
      display: block;
    }

    :root.light-theme .light-icon {
      display: none;
    }

    /* Reset and Base Styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      scroll-behavior: smooth;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.4;
      overflow-x: hidden;
      transition: background-color 0.3s ease, color 0.3s ease;
      margin: 0;
      padding: 0;
    }

    /* Theme Transition Radial Background - Behind photos */
    .theme-transition-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      opacity: 0;
      will-change: transform, opacity;
      transition: none;
    }

    .theme-transition-overlay.active {
      opacity: 1;
      transition: opacity 0.05s ease-out;
    }

    /* Radial expansion animations - scales up the gradient circle (faster) */
    @keyframes radialExpand {
      0% {
        clip-path: circle(0% at var(--click-x) var(--click-y));
      }
      100% {
        clip-path: circle(150% at var(--click-x) var(--click-y));
      }
    }

    /* Fixed Seamless Header */
    .header {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      width: 100% !important;
      z-index: 2001 !important;
      background: var(--bg-primary) !important;
      border-bottom: none;
      height: 60px;
      transition: all 0.3s ease;
      box-shadow: none;
      /* Mobile-specific fixes for iOS Safari */
      -webkit-position: fixed;
      transform: translateZ(0);
      -webkit-transform: translateZ(0);
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
    }


    .header-content {
      padding: 0 30px;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      max-width: 1600px;
      margin: 0 auto;
    }

    .logo {
      font-size: 20px;
      font-weight: 600;
      text-decoration: none;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      color: var(--text-primary);
      text-align: center;
      white-space: nowrap;
    }

    /* Header Controls */
    .header-controls {
      position: absolute;
      right: 30px;
      display: flex;
      align-items: center;
      gap: 20px;
    }

    /* Instagram Link */
    .instagram-link {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      transition: transform 0.05s ease;
      text-decoration: none;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instagram-link:hover {
      transform: scale(1.1);
    }

    /* Theme Toggle */
    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      transition: transform 0.05s ease;
    }

    .theme-toggle:hover {
      transform: scale(1.1);
    }

    .theme-toggle svg {
      filter: none;
      display: block;
    }

    :root.light-theme .theme-toggle svg {
      color: #000000;
    }

    :root:not(.light-theme) .theme-toggle svg {
      color: #ffffff;
    }

    /* Shuffle Button */
    .shuffle-button {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      padding: 0;
      transition: transform 0.05s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      /* Improve touch support on mobile */
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      user-select: none;
      -webkit-user-select: none;
    }

    .shuffle-button:hover {
      transform: scale(1.1);
    }

    .shuffle-button.shuffling svg {
      animation: rotate360 0.5s ease-in-out;
    }

    /* Enable SVG transformations on circles */
    .shuffle-button svg circle {
      transform-origin: center center;
      transform-box: fill-box;
      -webkit-transform-origin: center center;
      -webkit-transform-box: fill-box;
      will-change: transform, opacity;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      /* Force hardware acceleration on mobile */
      transform: translate3d(0, 0, 0);
      -webkit-transform: translate3d(0, 0, 0);
    }

    /* Dev Mode Toggle Button - Development Only */
    .dev-mode-toggle {
      background: none;
      border: 1px solid var(--text-primary);
      color: var(--text-primary);
      cursor: pointer;
      padding: 6px 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.2s ease, opacity 0.2s ease, background-color 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
      font-size: 11px;
      font-weight: 500;
      opacity: 0.6;
      border-radius: 4px;
      white-space: nowrap;
    }

    .dev-mode-toggle:hover {
      transform: scale(1.05);
      opacity: 1;
    }

    .dev-mode-toggle.prod-mode {
      background: var(--text-primary);
      color: var(--bg-primary);
      opacity: 0.8;
    }

    .dev-mode-toggle.prod-mode:hover {
      opacity: 1;
    }

    /* Larger font size for desktop */
    @media (min-width: 769px) {
      .dev-mode-toggle {
        font-size: 13px;
        padding: 8px 12px;
      }
    }

    /* Production Preview Mode - Hide dev-only elements without affecting DOM state */
    body.prod-preview-mode .location-shortcuts,
    body.prod-preview-mode .category-dropdown-btn,
    body.prod-preview-mode .category-dropdown-menu,
    body.prod-preview-mode .location-input-container,
    body.prod-preview-mode .lens-input-container,
    body.prod-preview-mode .manage-locations-btn,
    body.prod-preview-mode .manage-lenses-btn {
      opacity: 0 !important;
      pointer-events: none !important;
      width: 0 !important;
      height: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
      position: absolute !important;
      left: -9999px !important;
    }

    /* Theme toggle animations - Squeeze Effect Only */
    .theme-toggle svg path {
      transform-origin: center center;
      transform-box: fill-box;
    }

    /* Remove any extra space around SVG */
    .theme-toggle .light-icon,
    .theme-toggle .dark-icon {
      align-items: center;
      justify-content: center;
      line-height: 0;
    }

    /* Exit animation - Pure squeeze effect */
    @keyframes exitIconAnimation {
      0% {
        transform: scaleX(1) scaleY(1);
        opacity: 1;
      }
      50% {
        transform: scaleX(0) scaleY(1.5);
        opacity: 0;
      }
      100% {
        transform: scaleX(0) scaleY(1.5);
        opacity: 0;
      }
    }

    /* Enter animation - Pure squeeze effect */
    @keyframes enterIconAnimation {
      0% {
        transform: scaleX(0) scaleY(1.5);
        opacity: 0;
      }
      50% {
        transform: scaleX(0) scaleY(1.5);
        opacity: 0;
      }
      100% {
        transform: scaleX(1) scaleY(1);
        opacity: 1;
      }
    }

    @keyframes rotate360 {
      from {
        transform: rotate(0deg);
      }
      to {
        transform: rotate(360deg);
      }
    }

    /* Bubble animations for shuffle dots - rise up and return from below */
    @keyframes bubble1 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(-8px, -12px) scale(1.3);
        opacity: 0;
      }
      50% {
        transform: translate(-8px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble2 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(10px, -15px) scale(1.5);
        opacity: 0;
      }
      50% {
        transform: translate(10px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble3 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(-5px, -18px) scale(1.2);
        opacity: 0;
      }
      50% {
        transform: translate(-5px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble4 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(12px, -10px) scale(1.4);
        opacity: 0;
      }
      50% {
        transform: translate(12px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble5 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(-10px, -20px) scale(1.6);
        opacity: 0;
      }
      50% {
        transform: translate(-10px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble6 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(9px, -14px) scale(1.3);
        opacity: 0;
      }
      50% {
        transform: translate(9px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    @keyframes bubble7 {
      0% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
      45% {
        transform: translate(-12px, -8px) scale(1.5);
        opacity: 0;
      }
      50% {
        transform: translate(-12px, 20px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0) scale(1);
        opacity: 1;
      }
    }

    /* Main Content - Full Width */
    .main-content {
      margin-top: 60px;
      padding: 30px;
      padding-bottom: 100px;
      /* Fallback for older browsers */
      min-height: calc(var(--vh, 1vh) * 100 - 60px);
      /* Modern browsers with dvh support */
      min-height: calc(100dvh - 60px);
      position: relative;
      z-index: 1;
    }

    /* Masonry/Brick Wall Gallery Layout */
    .gallery-grid {
      column-count: 3;
      column-gap: 25px;
      max-width: 1600px;
      margin: 0 auto;
      padding-bottom: 120px;
      position: relative;
      z-index: 1;
    }

    .gallery-item {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      cursor: pointer;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      width: 100%;
      display: inline-block;
      margin-bottom: 25px;
      break-inside: avoid;
    }

    /* Fixed aspect ratios for gallery grid - uniform display */
    .gallery-item[data-orientation="portrait"] {
      aspect-ratio: 3/4;
    }

    .gallery-item[data-orientation="landscape"] {
      aspect-ratio: 4/3;
    }

    .gallery-item[data-orientation="square"] {
      aspect-ratio: 1/1;
    }

    .gallery-item:hover {
      transform: translateY(6px);
      box-shadow: 0 8px 25px var(--shadow);
    }

    .gallery-item img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: transform 0.3s ease, opacity 0.4s ease;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      opacity: 0;
    }

    .gallery-item img.loaded {
      opacity: 1;
    }

    .gallery-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, var(--card-bg) 25%, transparent 25%),
                  linear-gradient(-45deg, var(--card-bg) 25%, transparent 25%),
                  linear-gradient(45deg, transparent 75%, var(--card-bg) 75%),
                  linear-gradient(-45deg, transparent 75%, var(--card-bg) 75%);
      background-size: 20px 20px;
      background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
      opacity: 0.1;
      pointer-events: none;
      transition: opacity 0.4s ease;
    }

    .gallery-item.loaded::before {
      opacity: 0;
    }

    .gallery-item:hover img {
      transform: scale(1.03);
    }

    /* Image Overlay - Hidden on Hover */
    .gallery-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, var(--overlay-bg));
      color: white;
      padding: 25px 20px 15px;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
    }

    .gallery-overlay h3 {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .gallery-overlay p {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      opacity: 0.9;
    }

    /* Full-screen Translucent Filter Banner - Bottom */
    .floating-filter {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      z-index: 1001;
      background: linear-gradient(to bottom,
        transparent 0%,
        var(--filter-bg) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: none;
      padding: 20px;
      display: flex;
      justify-content: center;
      gap: 12px;
      transition: all 0.3s ease;
    }

    .floating-filter:hover {
      background: linear-gradient(to bottom,
        transparent 0%,
        var(--filter-hover-bg) 100%);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }


    .filter-tab {
      padding: 10px 18px;
      background: transparent;
      border: none;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
    }

    .filter-tab:hover {
      background: var(--card-bg);
      color: var(--text-primary);
    }

    .filter-tab.active {
      background: var(--filter-active-bg);
      color: var(--filter-active-text);
    }

    /* Lightbox */
    .lightbox {
      position: fixed;
      top: 60px;
      left: 0;
      width: 100%;
      height: calc(100% - 60px);
      background: var(--lightbox-bg);
      z-index: 2000;
      display: none;
      backdrop-filter: blur(2px);
      overflow: hidden;
    }

    .lightbox.active {
      display: flex;
    }

    /* Prevent body scroll when lightbox is active */
    body.lightbox-open {
      overflow: hidden !important;
      position: fixed !important;
      width: 100% !important;
      height: 100% !important;
    }

    /* Blend header into lightbox background */
    body.lightbox-open .header {
      background: var(--lightbox-bg) !important;
      border-bottom: none;
    }

    .lightbox-content {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .lightbox-image-container {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 30px 70px 30px 70px; /* Horizontal padding for arrows */
      position: relative;
    }

    .lightbox-image {
      max-width: min(100%, 1500px);
      max-height: min(100%, 1000px);
      object-fit: contain;
      border-radius: 8px;
      user-select: none;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      -webkit-user-drag: none;
      -khtml-user-drag: none;
      -moz-user-drag: none;
      -o-user-drag: none;
      user-drag: none;
      /* Disable all transitions for instant photo switching */
      transition: none !important;
      /* Prevent any flashing or dimming during src changes */
      will-change: contents;
      /* Optimize rendering for smooth transitions */
      image-rendering: -webkit-optimize-contrast;
      /* Ensure image stays opaque during loading */
      background-color: transparent;
    }

    .lightbox-sidebar {
      width: 350px;
      background: var(--lightbox-sidebar);
      padding: 16px 20px;
      padding-top: 70px;
      padding-bottom: 24px;
      overflow-y: auto;
      border-left: 1px solid var(--border-color);
      position: relative;
    }

    .lightbox-close {
      position: absolute;
      top: 20px;
      left: 20px;
      background: none;
      border-top: 1px solid rgba(255,255,255,0.3);
      border-left: none;
      border-right: none;
      border-bottom: none;
      border-radius: 12px;
      color: white;
      font-size: 18px;
      font-weight: 200;
      cursor: pointer;
      padding: 0;
      transition: all 0.3s ease;
      z-index: 2002;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.25;
    }

    .lightbox-close:hover {
      opacity: 0.7;
      transform: scale(1.05);
    }

    .metadata-section {
      margin-bottom: 8px;
    }

    .metadata-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 2px;
      color: var(--text-primary);
      line-height: 1.1;
    }

    .metadata-category {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-secondary);
      margin-bottom: 4px;
      font-weight: 400;
    }

    .metadata-item {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid var(--border-color);
    }

    /* Single-column layout for all metadata */
    .metadata-grid {
      display: flex;
      flex-direction: column;
      gap: 0;
      width: 100%;
      margin-top: 0;
    }

    .metadata-grid .metadata-item {
      display: flex;
      flex-direction: row;
      justify-content: space-between;
      align-items: center;
      padding: 3px 0;
      border-bottom: 1px solid var(--border-color);
    }

    .metadata-grid .metadata-label {
      font-size: 11px !important;
      opacity: 0.7;
      font-weight: 500;
    }

    .metadata-grid .metadata-value {
      font-size: 11px !important;
      text-align: right;
      font-weight: 400;
    }

    .metadata-label {
      font-weight: 500;
      color: var(--text-primary);
      font-size: 11px;
      line-height: 1.2;
      opacity: 0.7;
    }

    .metadata-value {
      color: var(--text-secondary);
      text-align: right;
      font-size: 11px;
      font-weight: 400;
      line-height: 1.2;
    }

    .location-input-container {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 60%;
      justify-content: flex-end;
    }

    .metadata-location-input {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      color: var(--text-secondary);
      flex: 1;
      text-align: right;
      font-weight: 400;
    }

    .metadata-location-input:focus {
      outline: none;
      border-color: var(--text-primary);
    }

    .metadata-location-input::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }

    .manage-locations-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
    }

    .manage-locations-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    .location-shortcuts {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      width: 100%;
      justify-content: flex-start;
      margin-top: 8px;
      box-sizing: border-box;
    }

    .location-shortcut-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      font-family: inherit;
    }

    .location-shortcut-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    /* Category Multi-Select Dropdown */
    .category-dropdown-container {
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: flex-end;
      width: auto;
      gap: 4px;
      flex-wrap: wrap;
    }

    .category-dropdown-display {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
    }

    .category-tag {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 10px;
      padding: 2px 6px;
      font-size: 9px;
      color: var(--text-primary);
      white-space: nowrap;
      font-weight: 400;
      line-height: 1;
    }

    .category-dropdown-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 9px;
      padding: 2px 6px;
      cursor: pointer;
      transition: all 0.2s ease;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 2px;
      line-height: 1;
    }

    .category-dropdown-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    .category-dropdown-menu {
      position: relative;
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      padding: 8px;
      display: none;
      flex-direction: column;
      gap: 4px;
      max-height: 200px;
      overflow-y: auto;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      z-index: 100;
    }

    .category-dropdown-menu.active {
      display: flex;
    }

    .category-dropdown-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s ease;
      font-size: 12px;
      color: var(--text-primary);
    }

    .category-dropdown-item:hover {
      background: var(--bg-secondary);
    }

    .category-dropdown-item input[type="checkbox"] {
      cursor: pointer;
      width: 14px;
      height: 14px;
      accent-color: var(--text-primary);
    }

    .category-dropdown-item label {
      cursor: pointer;
      flex: 1;
      user-select: none;
    }

    /* Location Manager Modal */
    .location-manager-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .location-manager-content {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .location-manager-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .location-manager-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .location-manager-close {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .location-manager-close:hover {
      background: var(--bg-secondary);
    }

    .location-manager-list {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .location-manager-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .location-manager-item-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
      background: transparent;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .location-manager-item-name:focus {
      outline: none;
      background: var(--bg-primary);
    }

    .location-manager-item-name.readonly {
      cursor: default;
    }

    .location-manager-item-count {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 2px 8px;
      background: var(--bg-primary);
      border-radius: 12px;
    }

    .location-manager-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .location-manager-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    .location-manager-btn.delete:hover {
      background: #e74c3c;
      border-color: #e74c3c;
      color: white;
    }

    .location-manager-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      padding: 40px 20px;
    }

    /* Location dropdown */
    .location-dropdown-container {
      margin-top: 8px;
      padding: 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      max-width: 100%;
    }

    .location-dropdown-header {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 8px;
      font-weight: 500;
    }

    .location-dropdown-list {
      display: flex;
      flex-direction: column;
      gap: 4px;
      max-height: 150px;
      overflow-y: auto;
    }

    .location-dropdown-item {
      padding: 6px 8px;
      font-size: 13px;
      color: var(--text-primary);
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .location-dropdown-item:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    .location-dropdown-item.current {
      opacity: 0.5;
      cursor: default;
      pointer-events: none;
    }

    /* Lens styling */
    .lens-input-container {
      display: flex;
      align-items: center;
      gap: 6px;
      width: 60%;
      justify-content: flex-end;
    }

    .metadata-lens-input {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      padding: 4px 8px;
      font-size: 13px;
      color: var(--text-secondary);
      flex: 1;
      text-align: right;
      font-family: inherit;
      font-weight: 400;
    }

    .metadata-lens-input:focus {
      outline: none;
      border-color: var(--text-primary);
    }

    .metadata-lens-input::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }

    .manage-lenses-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 14px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
      padding: 0;
    }

    .manage-lenses-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    /* Lens Manager Modal */
    .lens-manager-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .lens-manager-content {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .lens-manager-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .lens-manager-header h3 {
      margin: 0;
      font-size: 18px;
      font-weight: 500;
      color: var(--text-primary);
    }

    .lens-manager-close {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.2s ease;
    }

    .lens-manager-close:hover {
      background: var(--bg-secondary);
    }

    .lens-manager-list {
      padding: 20px;
      overflow-y: auto;
      flex: 1;
    }

    .lens-manager-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .lens-manager-item-name {
      flex: 1;
      font-size: 14px;
      color: var(--text-primary);
      background: transparent;
      border: none;
      padding: 4px 8px;
      border-radius: 4px;
    }

    .lens-manager-item-name:focus {
      outline: none;
      background: var(--bg-primary);
    }

    .lens-manager-item-name.readonly {
      cursor: default;
    }

    .lens-manager-item-count {
      font-size: 12px;
      color: var(--text-secondary);
      padding: 2px 8px;
      background: var(--bg-primary);
      border-radius: 12px;
    }

    .lens-manager-btn {
      background: var(--bg-primary);
      border: 1px solid var(--border-color);
      border-radius: 4px;
      color: var(--text-primary);
      font-size: 12px;
      padding: 4px 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .lens-manager-btn:hover {
      background: var(--text-primary);
      color: var(--bg-primary);
      border-color: var(--text-primary);
    }

    .lens-manager-btn.delete:hover {
      background: #e74c3c;
      border-color: #e74c3c;
      color: white;
    }

    .lens-manager-empty {
      text-align: center;
      color: var(--text-secondary);
      font-size: 14px;
      padding: 40px 20px;
    }


    /* Description section */
    .description-section {
      margin-bottom: 12px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-color);
    }

    .description-section-label {
      font-size: 10px;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.8px;
    }

    .description-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 6px;
      font-style: italic;
    }

    .description-caption {
      font-size: 12px;
      line-height: 1.5;
      color: var(--text-secondary);
      margin: 0;
      white-space: pre-line;
      text-align: justify;
      font-weight: 400;
    }

    /* Copyright section - less prominent, positioned bottom right */
    .copyright-section {
      opacity: 0.4;
      position: absolute;
      bottom: 15px;
      right: 20px;
      margin: 0;
      text-align: right;
    }

    .copyright-section .metadata-item {
      padding: 2px 0;
      font-size: 9px;
      border-bottom: none;
      justify-content: flex-end;
      line-height: 1.3;
    }

    .copyright-section .metadata-label {
      font-weight: 500;
      font-size: 8px;
      display: none;
    }

    .copyright-section .metadata-value {
      font-size: 9px;
      text-align: right;
      line-height: 1.3;
    }

    /* Navigation Arrows - Side borders only */
    .lightbox-nav {
      position: fixed;
      top: 50vh;
      transform: translateY(-50%);
      background: none;
      color: white;
      font-size: 32px;
      font-weight: 200;
      cursor: pointer;
      padding: 0;
      transition: all 0.3s ease;
      opacity: 0.25;
      z-index: 2001;
      line-height: 1;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 8px;
      pointer-events: auto;
    }

    .lightbox-nav:hover {
      opacity: 0.7;
      transform: translateY(-50%) scale(1.05);
    }

    .lightbox-prev {
      left: 20px;
      border-left: 1px solid rgba(255,255,255,0.3);
      border-top: none;
      border-right: none;
      border-bottom: none;
    }

    .lightbox-next {
      right: 370px; /* 350px sidebar + 20px padding */
      border-right: 1px solid rgba(255,255,255,0.3);
      border-top: none;
      border-left: none;
      border-bottom: none;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .gallery-grid {
        column-count: 2;
        column-gap: 22px;
      }

      .lightbox-sidebar {
        width: 300px;
      }

      .lightbox-image-container {
        padding: 25px 60px;
      }

      .lightbox-prev {
        left: 15px;
      }

      .lightbox-next {
        right: 315px; /* 300px sidebar + 15px padding */
      }
    }

    @media (max-width: 768px) {
      body {
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
      }

      /* Disable problematic animations on mobile */
      .gallery-item img {
        transition: opacity 0.3s ease;
      }

      /* Mobile-specific performance fixes */
      * {
        -webkit-tap-highlight-color: transparent;
        -webkit-touch-callout: none;
      }

      /* Prevent flickering during scroll */
      .main-content {
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
      }

      .gallery-grid {
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
      }

      .main-content {
        padding: 20px;
        padding-bottom: calc(120px + env(safe-area-inset-bottom));
        /* Fallback for older browsers */
        min-height: calc(var(--vh, 1vh) * 100 - env(safe-area-inset-bottom));
        /* Modern browsers with dvh support */
        min-height: calc(100dvh - env(safe-area-inset-bottom));
      }

      .gallery-grid {
        column-count: 2;
        column-gap: 18px;
      }

      .gallery-item {
        margin-bottom: 18px;
      }

      .floating-filter {
        padding: 15px;
        flex-wrap: wrap;
        justify-content: center;
        background: var(--bg-primary) !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
        will-change: auto;
      }

      .floating-filter:hover {
        background: var(--bg-primary) !important;
        backdrop-filter: none !important;
        -webkit-backdrop-filter: none !important;
      }

      .filter-tab {
        padding: 8px 14px;
        font-size: 12px;
      }

      .lightbox-content {
        flex-direction: column;
      }

      .lightbox-sidebar {
        width: 100%;
        height: 28%;
        max-height: 28%;
        border-left: none;
        border-top: 1px solid var(--border-color);
        padding: 6px 12px;
        padding-bottom: 4px;
        overflow-y: hidden;
        position: relative;
        display: flex;
        flex-direction: column;
      }

      .lightbox-sidebar > div {
        flex-shrink: 1;
      }

      .metadata-section {
        margin-bottom: 1px !important;
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .metadata-item {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 2px 0 !important;
        font-size: 8px !important;
        line-height: 1.1 !important;
        border-bottom: none;
      }

      /* Camera settings grid - single column */
      .metadata-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 0 !important;
        margin-top: 0 !important;
      }

      .metadata-grid .metadata-item {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        padding: 2px 0 !important;
        border-bottom: none;
      }

      .metadata-label {
        font-size: 8px !important;
        opacity: 0.7;
        font-weight: 500;
      }

      .metadata-value {
        font-size: 8px !important;
        text-align: right !important;
        font-weight: 400;
      }

      .metadata-grid .metadata-label {
        font-size: 8px !important;
      }

      .metadata-grid .metadata-value {
        font-size: 8px !important;
      }

      .metadata-title {
        font-size: 12px !important;
        margin-bottom: 0 !important;
        line-height: 1 !important;
      }

      .metadata-category {
        font-size: 8px !important;
        margin-bottom: 1px !important;
      }

      .category-dropdown-container {
        gap: 2px !important;
      }

      .category-tag {
        font-size: 8px !important;
        padding: 1px 4px !important;
      }

      .category-dropdown-btn {
        font-size: 8px !important;
        padding: 1px 4px !important;
      }

      .description-section {
        margin-bottom: 1px !important;
        padding-bottom: 2px !important;
        max-height: 40px;
        overflow: hidden;
      }

      .description-title {
        font-size: 8px !important;
        margin-bottom: 1px !important;
      }

      .description-caption {
        font-size: 8px !important;
        line-height: 1.1 !important;
        max-height: 28px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .copyright-section {
        position: absolute;
        bottom: 4px;
        right: 8px;
        margin: 0;
        padding: 0;
        border-top: none;
        opacity: 0.25;
        text-align: right;
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
      }

      .copyright-section .metadata-item {
        display: block !important;
        font-size: 5px !important;
        padding: 0 !important;
        border-bottom: none !important;
        line-height: 1.4 !important;
      }

      .copyright-section .metadata-value {
        display: block !important;
        font-size: 5px !important;
        text-align: right;
        line-height: 1.4 !important;
      }

      .copyright-section .metadata-label {
        display: none !important;
      }

      .lightbox-image-container {
        height: 72%;
        padding: 10px 35px; /* Horizontal padding for arrows */
        overflow: hidden;
      }

      .lightbox-nav {
        padding: 0;
        font-size: 28px;
        width: 38px;
        height: 38px;
        top: 34%;
        transform: translateY(-50%);
        opacity: 0.4;
        background: none;
        color: white;
        border-radius: 8px;
      }

      .lightbox-nav:hover,
      .lightbox-nav:active {
        opacity: 0.7;
      }

      .lightbox-prev {
        left: 5px;
        border-left: 1px solid rgba(255,255,255,0.3);
        border-top: none;
        border-right: none;
        border-bottom: none;
      }

      .lightbox-next {
        right: 5px;
        border-right: 1px solid rgba(255,255,255,0.3);
        border-top: none;
        border-left: none;
        border-bottom: none;
      }

      /* Remove rotation for vertical photos */
    }

    @media (max-width: 480px) {
      .main-content {
        padding: 12px;
        padding-bottom: 110px;
      }

      .gallery-grid {
        column-count: 2;
        column-gap: 15px;
      }

      .gallery-item {
        margin-bottom: 15px;
        border-radius: 10px;
        -webkit-tap-highlight-color: transparent;
      }

      .gallery-item:hover {
        transform: none;
        box-shadow: 0 4px 15px var(--shadow);
      }

      .gallery-item:hover img {
        transform: none;
      }

      .floating-filter {
        padding: 12px 16px;
      }

      .filter-tab {
        padding: 6px 12px;
        font-size: 12px;
      }

      .lightbox-close {
        width: 40px;
        height: 40px;
        font-size: 20px;
        top: 15px;
        left: 15px;
        border-radius: 14px;
      }

      .metadata-item {
        font-size: 8px;
        padding: 4px 0;
        line-height: 1.1;
      }

      .metadata-label {
        font-size: 8px;
        font-weight: 500;
      }

      .metadata-value {
        font-size: 8px;
      }

      .metadata-title {
        font-size: 12px;
        margin-bottom: 2px;
        line-height: 1.1;
      }

      .metadata-category {
        font-size: 8px;
        margin-bottom: 6px;
      }

      .metadata-section {
        margin-bottom: 10px;
      }

      .description-section {
        margin-bottom: 15px;
        padding-bottom: 10px;
      }

      .description-title {
        font-size: 8px;
        margin-bottom: 6px;
      }

      .description-caption {
        font-size: 8px;
        line-height: 1.5;
        white-space: pre-line;
        text-align: justify;
      }

      .lightbox-sidebar {
        padding: 8px 12px;
        padding-bottom: 8px;
        padding-top: 10px;
        height: 33%;
        max-height: 33%;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .metadata-section {
        margin-bottom: 1px !important;
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .metadata-item {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        align-items: center !important;
        padding: 2px 0 !important;
        font-size: 8px !important;
        line-height: 1.1 !important;
        border-bottom: none;
      }

      /* Camera settings grid - single column */
      .metadata-grid {
        display: flex !important;
        flex-direction: column !important;
        gap: 0 !important;
        margin-top: 0 !important;
      }

      .metadata-grid .metadata-item {
        display: flex !important;
        flex-direction: row !important;
        justify-content: space-between !important;
        padding: 2px 0 !important;
        border-bottom: none;
      }

      .metadata-label {
        font-size: 8px !important;
        opacity: 0.7;
        font-weight: 500;
      }

      .metadata-value {
        font-size: 8px !important;
        text-align: right !important;
        font-weight: 400;
      }

      .metadata-grid .metadata-label {
        font-size: 8px !important;
      }

      .metadata-grid .metadata-value {
        font-size: 8px !important;
      }

      .description-section {
        margin-bottom: 3px !important;
        padding-bottom: 3px !important;
        max-height: 50px;
        overflow: hidden;
      }

      .description-title {
        font-size: 8px !important;
        margin-bottom: 2px !important;
      }

      .description-caption {
        font-size: 8px !important;
        line-height: 1.2 !important;
        max-height: 35px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .metadata-title {
        font-size: 12px !important;
        margin-bottom: 0 !important;
        line-height: 1 !important;
      }

      .metadata-category {
        font-size: 8px !important;
        margin-bottom: 1px !important;
      }

      .category-dropdown-container {
        gap: 2px !important;
      }

      .category-tag {
        font-size: 8px !important;
        padding: 1px 4px !important;
      }

      .category-dropdown-btn {
        font-size: 8px !important;
        padding: 1px 4px !important;
      }

      .copyright-section {
        padding-top: 6px;
      }

      .copyright-section .metadata-item {
        font-size: 5px !important;
        padding: 1px 0 !important;
      }

      .copyright-section .metadata-value {
        font-size: 5px !important;
      }

      .lightbox-image-container {
        height: 57%;
      }
    }

    @media (max-width: 360px) {
      .main-content {
        padding: 10px;
        padding-bottom: 100px;
      }

      .gallery-grid {
        column-count: 2;
        column-gap: 12px;
      }

      .gallery-item {
        margin-bottom: 12px;
        border-radius: 8px;
      }

      .floating-filter {
        padding: 10px 12px;
      }

      .filter-tab {
        padding: 5px 10px;
        font-size: 11px;
      }
    }

    /* Loading Animation */
    .gallery-item {
      animation: fadeInScale 0.6s ease-out;
    }

    @keyframes fadeInScale {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    /* Hidden class for filtering */
    .hidden {
      display: none;
    }

    /* Focus states for accessibility */
    /* Remove outline completely - lightbox provides visual feedback */
    .filter-tab:focus,
    .gallery-item:focus,
    .gallery-item:focus-visible {
      outline: none !important;
    }

    /* Keep focus outline only for filter tabs on keyboard navigation */
    .filter-tab:focus-visible {
      outline: 2px solid #007bff;
      outline-offset: 2px;
    }

    .theme-toggle:focus {
      outline: none;
    }

    /* Location and Time Display */
    .location-time {
      position: absolute;
      left: 30px;
      font-size: 16px;
      font-weight: 400;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-primary);
    }

    .location-time .location {
      margin: 0;
    }

    .location-time .time {
      margin: 0;
      font-variant-numeric: tabular-nums;
      letter-spacing: 0.05em;
    }

    /* Seconds styling - same as all other text */
    .time-seconds {
      font-weight: 400;
      font-size: inherit;
      color: inherit;
      display: inline-block;
    }


    /* Mobile header layout fixes */
    @media (max-width: 768px) {
      /* Reinforce fixed positioning on mobile */
      .header {
        position: fixed !important;
        top: 0 !important;
        left: 0 !important;
        right: 0 !important;
        width: 100% !important;
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
        will-change: transform;
      }

      .location-time {
        flex-direction: column;
        align-items: flex-start;
        gap: 2px;
        font-size: 14px;
        left: 20px;
      }

      .logo {
        font-size: 18px;
      }

      .header-controls {
        right: 15px;
        gap: 2px;
      }

      .instagram-link {
        font-size: 18px;
        padding: 8px;
      }

      .theme-toggle {
        font-size: 18px;
        padding: 8px;
      }

      .shuffle-button {
        font-size: 18px;
        padding: 8px;
      }
    }

    @media (max-width: 480px) {
      /* Reinforce fixed positioning on smaller mobile devices */
      .header {
        position: fixed !important;
        top: 0 !important;
        transform: translate3d(0, 0, 0);
        -webkit-transform: translate3d(0, 0, 0);
      }

      .location-time {
        font-size: 13px;
        left: 15px;
      }

      .logo {
        font-size: 16px;
      }

      .header-controls {
        right: 12px;
        gap: 0px;
      }

      .instagram-link {
        font-size: 16px;
        padding: 6px;
      }

      .theme-toggle {
        font-size: 16px;
        padding: 6px;
      }

      .shuffle-button {
        font-size: 16px;
        padding: 6px;
      }
    }

    /* Fix scroll gaps by ensuring background coverage */
    html {
      background: var(--bg-primary) !important;
    }

    /* Copyright Footer */
    .copyright-footer {
      background: var(--bg-primary);
      border-top: 1px solid var(--border-color);
      padding: 30px;
      text-align: center;
      margin-top: 50px;
    }

    .copyright-content {
      max-width: 1600px;
      margin: 0 auto;
    }

    .copyright-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
      margin: 0 0 5px 0;
    }

    .legal-text {
      font-size: 10px;
      font-weight: 400;
      color: var(--text-secondary);
      margin: 0;
      line-height: 1.4;
    }

    /* Critical Performance Optimizations - Mobile Safe */
    /* Reduced motion preference support */
    @media (prefers-reduced-motion: reduce) {
      * {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* Targeted transitions only - no universal selectors */
    .header,
    .theme-toggle,
    .instagram-link,
    .shuffle-button,
    .filter-tab,
    .floating-filter {
      transition: background-color 0.2s ease, color 0.2s ease, border-color 0.2s ease;
    }

    /* GPU acceleration for gallery items - Desktop only */
    @media (min-width: 769px) {
      .gallery-item {
        transform: translateZ(0);
        backface-visibility: hidden;
        -webkit-transform: translateZ(0);
        -webkit-backface-visibility: hidden;
      }
    }

    /* Optimize scrolling performance */
    .main-content {
      -webkit-overflow-scrolling: touch;
    }

    /* Critical image loading optimization - Desktop only */
    @media (min-width: 769px) {
      .gallery-item img {
        content-visibility: auto;
        contain-intrinsic-size: 300px 225px;
      }
    }

    /* Fast hover transforms - Desktop only */
    @media (min-width: 769px) {
      .gallery-item:hover {
        transform: translateZ(0) translateY(6px);
      }
    }

  </style>

  <!-- Theme Transition Overlay -->
  <div class="theme-transition-overlay" id="themeTransitionOverlay"></div>

  <!-- Minimal Header -->
  <header class="header">
    <div class="header-content">
      <div class="location-time" id="locationTime">
        <div class="location">Utrecht</div>
        <div class="time" id="timeDisplay">00:00:00</div>
      </div>
      <a href="/" class="logo">{title}</a>
      <div class="header-controls">
        <a href="https://www.instagram.com/rigeveryday/" class="instagram-link" id="instagramLink" target="_blank" rel="noopener noreferrer" aria-label="Visit Instagram">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="5" y="8" width="14" height="11" rx="0.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <circle cx="12" cy="13.5" r="3.5" stroke="currentColor" stroke-width="1.5" fill="none"/>
            <rect x="8" y="5" width="8" height="3" rx="0.5" fill="currentColor"/>
            <rect x="15.5" y="9.5" width="2" height="2" rx="0.3" fill="currentColor"/>
            <circle cx="7.5" cy="10" r="0.6" fill="currentColor"/>
          </svg>
        </a>
        <button class="shuffle-button" id="shuffleButton" aria-label="Shuffle photos">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
            <circle cx="6" cy="6" r="2"></circle>
            <circle cx="18" cy="8" r="2"></circle>
            <circle cx="8" cy="12" r="2"></circle>
            <circle cx="16" cy="16" r="2"></circle>
            <circle cx="12" cy="20" r="2"></circle>
            <circle cx="20" cy="18" r="2"></circle>
            <circle cx="4" cy="16" r="2"></circle>
          </svg>
        </button>
        {import.meta.env.DEV && (
          <button class="dev-mode-toggle" id="devModeToggle" aria-label="Toggle production preview" title="Preview how the site looks in production">
            DEV
          </button>
        )}
        <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
          <span class="light-icon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M12 2.25a.75.75 0 01.75.75v2.25a.75.75 0 01-1.5 0V3a.75.75 0 01.75-.75zM7.5 12a4.5 4.5 0 119 0 4.5 4.5 0 01-9 0zM18.894 6.166a.75.75 0 00-1.06-1.06l-1.591 1.59a.75.75 0 101.06 1.061l1.591-1.59zM21.75 12a.75.75 0 01-.75.75h-2.25a.75.75 0 010-1.5H21a.75.75 0 01.75.75zM17.834 18.894a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 10-1.061 1.06l1.59 1.591zM12 18a.75.75 0 01.75.75V21a.75.75 0 01-1.5 0v-2.25A.75.75 0 0112 18zM7.758 17.303a.75.75 0 00-1.061-1.06l-1.591 1.59a.75.75 0 001.06 1.061l1.591-1.59zM6 12a.75.75 0 01-.75.75H3a.75.75 0 010-1.5h2.25A.75.75 0 016 12zM6.697 7.757a.75.75 0 001.06-1.06l-1.59-1.591a.75.75 0 00-1.061 1.06l1.59 1.591z"/>
            </svg>
          </span>
          <span class="dark-icon" id="moonIcon">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
              <path d="M9.528 1.718a.75.75 0 01.162.819A8.97 8.97 0 009 6a9 9 0 009 9 8.97 8.97 0 003.463-.69.75.75 0 01.981.98 10.503 10.503 0 01-9.694 6.46c-5.799 0-10.5-4.701-10.5-10.5 0-4.368 2.667-8.112 6.46-9.694a.75.75 0 01.818.162z"/>
            </svg>
          </span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Gallery Grid - 4:3 Aspect Ratio -->
    <section class="gallery-grid">
      {galleryItems.map((item, index) => (
        <div
          class={`gallery-item ${index < 24 ? 'loaded' : ''}`}
          data-category={item.originalCategory}
          data-index={index}
          data-href={item.href}
          data-orientation={item.orientation || 'landscape'}
          tabindex="0"
        >
          <img
            src={index < 24 ? item.href : ''}
            data-src={item.href}
            alt={item.label}
            class={index < 24 ? 'loaded' : 'lazy-load'}
          />
          <div class="gallery-overlay">
            <h3>{item.label}</h3>
            <p>{item.category}</p>
          </div>
        </div>
      ))}
    </section>

    <!-- Copyright and Legal Notices -->
    <footer class="copyright-footer">
      <div class="copyright-content">
        <p class="copyright-text">Â© {currentYear} Shreyan Sengupta. All rights reserved. Text and data mining is not permitted.</p>
      </div>
    </footer>
  </main>

  <!-- Floating Filter Banner -->
  <div class="floating-filter">
    {categories.map((category) => (
      <button
        class={`filter-tab ${category.value === 'all' ? 'active' : ''}`}
        data-filter={category.value}
      >
        {category.label}
      </button>
    ))}
  </div>

  <!-- Lightbox -->
  <div class="lightbox" id="lightbox">
    <div class="lightbox-content">
      <div class="lightbox-image-container">
        <img class="lightbox-image" id="lightboxImage" src="" alt="" decoding="sync">
        <button class="lightbox-close" id="lightboxClose">&times;</button>
        <button class="lightbox-nav lightbox-prev" id="lightboxPrev">â€¹</button>
        <button class="lightbox-nav lightbox-next" id="lightboxNext">â€º</button>
      </div>
      <div class="lightbox-sidebar">
        <div class="metadata-section description-section" id="descriptionSection" style="display: none;">
          <h4 class="description-title" id="descriptionTitle"></h4>
          <p class="description-caption" id="descriptionCaption"></p>
        </div>

        <div class="metadata-section">
          <!-- Location, Date, Time first -->
          <div class="metadata-item" id="metadataLocationItem" style="display: none;">
            <span class="metadata-label">Location</span>
            <span class="metadata-value" id="metadataLocationDisplay"></span>
            {import.meta.env.DEV && (
              <>
                <div class="location-input-container" style="display: none;">
                  <input type="text" id="metadataLocationInput" list="locationSuggestions" class="metadata-location-input" placeholder="Enter location...">
                  <button id="manageLocationsBtn" class="manage-locations-btn" title="Manage locations">âš™</button>
                </div>
                <div class="location-shortcuts" id="locationShortcuts" style="display: none;">
                  <!-- Shortcut buttons will be populated here -->
                </div>
                <datalist id="locationSuggestions"></datalist>
              </>
            )}
          </div>
          {import.meta.env.DEV && (
            <div class="location-manager-modal" id="locationManagerModal" style="display: none;">
              <div class="location-manager-content">
                <div class="location-manager-header">
                  <h3>Manage Locations</h3>
                  <button class="location-manager-close" id="closeLocationManager">Ã—</button>
                </div>
                <div class="location-manager-list" id="locationManagerList">
                  <!-- Locations will be populated here -->
                </div>
              </div>
            </div>
          )}
          <div class="metadata-item">
            <span class="metadata-label">Date</span>
            <span class="metadata-value" id="metadataDate">---</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Time</span>
            <span class="metadata-value" id="metadataTime">---</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">File #</span>
            <span class="metadata-value" id="metadataFileNumber">8413</span>
          </div>
          <div class="metadata-item" id="metadataCategoryItem">
            <span class="metadata-label">Categories</span>
            <div class="category-dropdown-container">
              <div class="category-dropdown-display" id="categoryDisplay">
                <!-- Primary category tag will be displayed here -->
              </div>
              {import.meta.env.DEV && (
                <>
                  <button class="category-dropdown-btn" id="categoryDropdownBtn">
                    <span>+ Add Categories</span>
                  </button>
                  <div class="category-dropdown-menu" id="categoryDropdownMenu">
                    <!-- Category checkboxes will be populated here -->
                  </div>
                </>
              )}
            </div>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Camera</span>
            <span class="metadata-value" id="metadataCamera">Canon EOS R5</span>
          </div>
          <div class="metadata-item" id="metadataLensItem" style="display: none;">
            <span class="metadata-label">Lens</span>
            <span class="metadata-value" id="metadataLensDisplay"></span>
            {import.meta.env.DEV && (
              <>
                <div class="lens-input-container" style="display: none;">
                  <input type="text" id="metadataLensInput" list="lensSuggestions" class="metadata-lens-input" placeholder="Enter lens...">
                  <button id="manageLensesBtn" class="manage-lenses-btn" title="Manage lenses">âš™</button>
                </div>
                <datalist id="lensSuggestions"></datalist>
              </>
            )}
          </div>
          {import.meta.env.DEV && (
            <div class="lens-manager-modal" id="lensManagerModal" style="display: none;">
              <div class="lens-manager-content">
                <div class="lens-manager-header">
                  <h3>Manage Lenses</h3>
                  <button class="lens-manager-close" id="closeLensManager">Ã—</button>
                </div>
                <div class="lens-manager-list" id="lensManagerList">
                  <!-- Lenses will be populated here -->
                </div>
              </div>
            </div>
          )}

          <!-- Camera settings in compact two-column grid -->
          <div class="metadata-grid">
            <div class="metadata-item">
              <span class="metadata-label">Focal Length</span>
              <span class="metadata-value" id="metadataFocalLength">50mm</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Aperture</span>
              <span class="metadata-value" id="metadataAperture">f/2.8</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">Shutter</span>
              <span class="metadata-value" id="metadataShutterSpeed">1/250s</span>
            </div>
            <div class="metadata-item">
              <span class="metadata-label">ISO</span>
              <span class="metadata-value" id="metadataISO">400</span>
            </div>
          </div>
        </div>

        <div class="metadata-section copyright-section">
          <div class="metadata-item">
            <span class="metadata-label">Copyright</span>
            <span class="metadata-value">Â© {currentYear} Shreyan Sengupta.<br>All rights reserved.</span>
          </div>
          <div class="metadata-item">
            <span class="metadata-label">Usage Rights</span>
            <span class="metadata-value">Text and data mining not permitted</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Pass gallery data to client-side -->
  <script type="application/json" id="gallery-data" is:inline set:html={JSON.stringify(galleryItems)}></script>

  <script>
    // Extend Window interface for TypeScript
    declare global {
      interface Window {
        galleryData: any[];
      }
    }

    // Development-only logging wrapper
    const isDev = import.meta.env.DEV;
    const devLog = (...args: any[]) => {
      if (isDev) console.log(...args);
    };
    const devError = (...args: any[]) => {
      if (isDev) console.error(...args);
    };

    // Dynamic viewport height fallback for older browsers
    function initViewportHeight() {
      // Check if dvh is supported
      const supportsDvh = CSS.supports('height', '100dvh');

      if (!supportsDvh) {
        devLog('dvh not supported, using JavaScript fallback');

        // Set CSS custom property with actual viewport height
        const setVh = () => {
          const vh = window.innerHeight * 0.01;
          document.documentElement.style.setProperty('--vh', `${vh}px`);
        };

        // Set on load
        setVh();

        // Update on resize (handles mobile browser chrome changes)
        let resizeTimer: ReturnType<typeof setTimeout>;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(setVh, 100);
        });

        // Update on orientation change
        window.addEventListener('orientationchange', setVh);
      } else {
        devLog('dvh is supported');
      }
    }

    // Initialize viewport height fix
    initViewportHeight();

    // Theme management
    function initTheme() {
      const themeToggle = document.getElementById('themeToggle');
      const root = document.documentElement;

      devLog('Theme system initializing...');

      // Apply theme function
      function applyTheme(theme: string) {
        devLog('Applying theme:', theme);

        // Toggle theme class and inline styles for instant switching
        if (theme === 'light') {
          root.classList.add('light-theme');
          root.style.backgroundColor = '#ffffff';
          root.style.color = '#000000';
        } else {
          root.classList.remove('light-theme');
          root.style.backgroundColor = '#000000';
          root.style.color = '#ffffff';
        }

        // Update Instagram link based on theme
        const instagramLink = document.getElementById('instagramLink') as HTMLAnchorElement;
        if (instagramLink) {
          if (theme === 'dark') {
            instagramLink.href = 'https://www.instagram.com/noir.kiln/';
            instagramLink.setAttribute('aria-label', 'Visit @noir.kiln on Instagram');
          } else {
            instagramLink.href = 'https://www.instagram.com/rigeveryday/';
            instagramLink.setAttribute('aria-label', 'Visit @rigeveryday on Instagram');
          }
        }

        localStorage.setItem('theme', theme);
        devLog('Theme applied successfully:', theme);
      }

      // Get saved theme or default to dark (with validation)
      const rawTheme = localStorage.getItem('theme');
      const validThemes = ['light', 'dark'];
      const savedTheme = (rawTheme && validThemes.includes(rawTheme)) ? rawTheme : 'dark';
      devLog('Saved theme:', savedTheme);
      applyTheme(savedTheme);

      // Theme toggle event - radial emanation effect (background)
      if (themeToggle) {
        let currentTheme = savedTheme;
        let isToggling = false;

        themeToggle.addEventListener('click', (e) => {
          e.preventDefault();

          // Prevent rapid clicking (debounce)
          if (isToggling) return;
          isToggling = true;

          devLog('Theme toggle clicked, current theme:', currentTheme);

          const nextTheme = currentTheme === 'light' ? 'dark' : 'light';
          devLog('Switching to:', nextTheme);

          // Get button position for radial effect
          const rect = themeToggle.getBoundingClientRect();
          const buttonX = rect.left + rect.width / 2;
          const buttonY = rect.top + rect.height / 2;

          // Convert to percentages for CSS
          const clickXPercent = (buttonX / window.innerWidth) * 100;
          const clickYPercent = (buttonY / window.innerHeight) * 100;

          // Create radial background transition
          const overlay = document.getElementById('themeTransitionOverlay');
          if (overlay) {
            // Set the new theme color as background
            const bgColor = nextTheme === 'dark' ? '#000000' : '#ffffff';
            overlay.style.background = bgColor;

            // Set CSS custom properties for clip-path animation
            overlay.style.setProperty('--click-x', `${clickXPercent}%`);
            overlay.style.setProperty('--click-y', `${clickYPercent}%`);

            // Clear any previous animation
            overlay.style.animation = 'none';
            void overlay.offsetWidth; // Force reflow

            // Start the radial expansion animation (faster)
            overlay.style.animation = `radialExpand 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards`;
            overlay.classList.add('active');

            devLog(`Starting background radial transition from (${clickXPercent}%, ${clickYPercent}%)`);
          }

          // Animate the current icon disappearing
          const currentIcon = themeToggle.querySelector('.light-icon, .dark-icon:not([style*="display: none"])');
          const currentPath = currentIcon?.querySelector('path');

          if (currentPath) {
            // Clear any existing animation
            (currentPath as unknown as HTMLElement).style.animation = 'none';
            void themeToggle.offsetWidth; // Force reflow

            // Pure squeeze exit animation (faster)
            (currentPath as unknown as HTMLElement).style.animation = `exitIconAnimation 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards`;

            devLog(`Playing exitIconAnimation (squeeze) on current icon`);
          }

          // Apply theme quickly
          setTimeout(() => {
            currentTheme = nextTheme;
            applyTheme(currentTheme);

            // Animate the new icon appearing immediately
            setTimeout(() => {
              const newIcon = themeToggle.querySelector('.light-icon, .dark-icon:not([style*="display: none"])');
              const newPath = newIcon?.querySelector('path');

              if (newPath) {
                (newPath as unknown as HTMLElement).style.animation = 'enterIconAnimation 0.15s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards';
                devLog('New icon appearing with enterIconAnimation (squeeze)');
              }
            }, 10);
          }, 50);

          // Clean up overlay and reset debounce (faster)
          setTimeout(() => {
            if (overlay) {
              overlay.classList.remove('active');
              overlay.style.animation = 'none';
              overlay.style.clipPath = 'none';
            }
            isToggling = false;
          }, 550);
        });
        devLog('Theme toggle event listener added with background radial emanation effect');
      } else {
        devError('Theme toggle button not found!');
      }
    }

    document.addEventListener('DOMContentLoaded', function() {
      // Safe JSON parse helper with error handling
      function safeJSONParse<T>(data: string | null, fallback: T): T {
        if (!data) return fallback;
        try {
          return JSON.parse(data) as T;
        } catch (error) {
          console.error('Failed to parse JSON data:', error);
          return fallback;
        }
      }

      // Load gallery data from JSON script tag
      const galleryDataScript = document.getElementById('gallery-data');
      window.galleryData = galleryDataScript ? safeJSONParse(galleryDataScript.textContent, []) : [];

      initTheme();

      // Dev Mode Toggle - Production Preview (development only)
      if (import.meta.env.DEV) {
        const devModeToggle = document.getElementById('devModeToggle');
        if (devModeToggle) {
          // Check localStorage for saved preference
          const isProdMode = localStorage.getItem('prodPreviewMode') === 'true';

          // Function to update UI based on mode
          function updateDevMode(prodMode: boolean) {
            if (prodMode) {
              // Production preview mode - hide dev elements
              document.body.classList.add('prod-preview-mode');
              devModeToggle!.classList.add('prod-mode');
              devModeToggle!.textContent = 'PROD';
              devModeToggle!.title = 'Switch back to development mode';
            } else {
              // Development mode - show dev elements
              document.body.classList.remove('prod-preview-mode');
              devModeToggle!.classList.remove('prod-mode');
              devModeToggle!.textContent = 'DEV';
              devModeToggle!.title = 'Preview how the site looks in production';
            }

            localStorage.setItem('prodPreviewMode', prodMode.toString());
          }

          // Initialize with saved preference
          updateDevMode(isProdMode);

          // Toggle on click
          devModeToggle.addEventListener('click', () => {
            const currentMode = localStorage.getItem('prodPreviewMode') === 'true';
            const newMode = !currentMode;
            console.log('ðŸ”„ Toggling mode:', currentMode ? 'PROD â†’ DEV' : 'DEV â†’ PROD');
            updateDevMode(newMode);

            // Get current lightbox image to refresh its metadata display
            const currentImage = document.querySelector('.lightbox-image:not([style*="display: none"])');
            console.log('Current image found:', !!currentImage);
            if (currentImage) {
              const imageLabel = currentImage.getAttribute('data-label') || '';
              console.log('Image label:', imageLabel);

              // Get saved data from localStorage
              const savedLocations = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
              const savedLenses = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});
              const location = savedLocations[imageLabel] || '';
              const lens = savedLenses[imageLabel] || '';
              console.log('Location:', location, '| Lens:', lens);

              // Get display elements
              const metadataLocationDisplay = document.getElementById('metadataLocationDisplay');
              const metadataLensDisplay = document.getElementById('metadataLensDisplay');
              const locationInputContainer = document.querySelector('.location-input-container') as HTMLElement;
              const lensInputContainer = document.querySelector('.lens-input-container') as HTMLElement;
              const metadataLocationInput = document.getElementById('metadataLocationInput') as HTMLInputElement;
              const metadataLensInput = document.getElementById('metadataLensInput') as HTMLInputElement;

              console.log('ðŸ“¦ Element check:', {
                'locationInputContainer exists': !!locationInputContainer,
                'lensInputContainer exists': !!lensInputContainer,
                'metadataLocationInput exists': !!metadataLocationInput,
                'metadataLensInput exists': !!metadataLensInput,
                'categoryDropdownBtn exists': !!document.getElementById('categoryDropdownBtn')
              });

              if (newMode) {
                // Switching TO production mode: show displays, hide inputs
                console.log('âž¡ï¸ Switching to PROD mode - hiding inputs, showing displays');
                if (metadataLocationDisplay && location) {
                  metadataLocationDisplay.style.display = 'inline';
                  metadataLocationDisplay.innerHTML = location.replace(', ', '<br>');
                }
                if (metadataLensDisplay && lens) {
                  metadataLensDisplay.style.display = 'inline';
                  metadataLensDisplay.textContent = lens;
                }
                // Hide input containers
                if (locationInputContainer) locationInputContainer.style.display = 'none';
                if (lensInputContainer) lensInputContainer.style.display = 'none';
              } else {
                // Switching TO dev mode: show inputs, hide displays
                console.log('â¬…ï¸ Switching to DEV mode - showing inputs, hiding displays');
                if (metadataLocationDisplay && locationInputContainer) {
                  metadataLocationDisplay.style.display = 'none';
                  locationInputContainer.style.display = 'flex';
                  console.log('âœ… Location input container set to flex');
                }
                if (metadataLensDisplay && lensInputContainer) {
                  metadataLensDisplay.style.display = 'none';
                  lensInputContainer.style.display = 'flex';
                  console.log('âœ… Lens input container set to flex');
                }

                // Update input values
                if (metadataLocationInput && location) {
                  metadataLocationInput.value = location;
                }
                if (metadataLensInput && lens) {
                  metadataLensInput.value = lens;
                }

                // Remove any inline display:none styles that might have been set
                const devElements = [
                  document.getElementById('locationShortcuts'),
                  document.getElementById('categoryDropdownBtn'),
                  document.getElementById('categoryDropdownMenu'),
                  document.getElementById('manageLocationsBtn'),
                  document.getElementById('manageLensesBtn')
                ];

                devElements.forEach(el => {
                  if (el && (el as HTMLElement).style.display === 'none') {
                    (el as HTMLElement).style.display = '';
                  }
                });
              }
            }
          });
        }
      }

      // Progressive Image Loading with Intersection Observer
      let imageObserver: IntersectionObserver; // Declare in broader scope

      function initImageLoading() {
        imageObserver = new IntersectionObserver((entries, observer) => {
          entries.forEach(entry => {
            if (entry.isIntersecting) {
              const img = entry.target as HTMLImageElement;
              const container = img.closest('.gallery-item') as HTMLElement;

              // Load the image using improved loading logic
              const dataSrc = img.dataset.src;
              if (dataSrc) {
                // Use requestIdleCallback for non-blocking image loading
                const loadImage = () => {
                  const tempImg = new Image();
                  tempImg.onload = () => {
                    img.src = dataSrc;
                    img.classList.add('loaded');
                    if (container) {
                      container.classList.add('loaded');
                    }
                    devLog('Lazy loaded image:', dataSrc);
                  };
                  tempImg.onerror = () => {
                    img.classList.add('loaded'); // Still fade in to avoid blank space
                    if (container) {
                      container.classList.add('loaded');
                    }
                    devError('Failed to load image:', dataSrc);
                  };
                  tempImg.src = dataSrc;
                  img.removeAttribute('data-src');
                  observer.unobserve(img);
                };

                if ('requestIdleCallback' in window) {
                  requestIdleCallback(loadImage);
                } else {
                  setTimeout(loadImage, 0);
                }
              }
            }
          });
        }, {
          // Load images when they're 150px from entering the viewport
          rootMargin: '150px',
          threshold: 0.01
        });

        // Observe all lazy-load images
        const lazyImages = document.querySelectorAll('img.lazy-load');
        lazyImages.forEach(img => {
          imageObserver.observe(img);
        });

        devLog('Image loading observer initialized for', lazyImages.length, 'images');
      }

      // Initialize progressive loading
      initImageLoading();

      // Utrecht time display
      function updateUtrechtTime() {
        try {
          const now = new Date();

          const timeString = now.toLocaleTimeString('en-US', {
            timeZone: "Europe/Amsterdam",
            hour12: false,
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
          });

          const timeElement = document.getElementById('timeDisplay');
          if (timeElement) {
            // Split time string to wrap seconds in a span for dramatic effect
            const timeParts = timeString.split(':');
            if (timeParts.length === 3 && timeParts[2] !== undefined) {
              // Safely create elements to avoid XSS
              timeElement.textContent = '';
              const hoursText = document.createTextNode(`${timeParts[0]}:${timeParts[1]}:`);
              const secondsSpan = document.createElement('span');
              secondsSpan.className = 'time-seconds';
              secondsSpan.textContent = timeParts[2];
              timeElement.appendChild(hoursText);
              timeElement.appendChild(secondsSpan);
            } else {
              timeElement.textContent = timeString;
            }
          } else {
            devError('timeDisplay element not found');
          }
        } catch (error) {
          devError('Error updating Utrecht time:', error);
          // Fallback to simple time display
          const timeElement = document.getElementById('timeDisplay');
          if (timeElement) {
            const now = new Date();
            const simpleTime = now.toTimeString().split(' ')[0] || '00:00:00';
            const timeParts = simpleTime.split(':');
            if (timeParts.length === 3 && timeParts[2] !== undefined) {
              // Safely create elements to avoid XSS
              timeElement.textContent = '';
              const hoursText = document.createTextNode(`${timeParts[0]}:${timeParts[1]}:`);
              const secondsSpan = document.createElement('span');
              secondsSpan.className = 'time-seconds';
              secondsSpan.textContent = timeParts[2];
              timeElement.appendChild(hoursText);
              timeElement.appendChild(secondsSpan);
            } else {
              timeElement.textContent = simpleTime;
            }
          }
        }
      }

      // Update time immediately and then every second
      updateUtrechtTime();
      setInterval(updateUtrechtTime, 1000);

      // Dynamic filter sorting based on photo counts
      function sortFiltersByPhotoCount() {
        const galleryItems = document.querySelectorAll('.gallery-item');
        const filterContainer = document.querySelector('.floating-filter');
        const filterTabs = document.querySelectorAll('.filter-tab');

        // Count photos in each category
        const categoryCounts: { [key: string]: number } = {};

        // Initialize all categories with 0 count
        filterTabs.forEach(tab => {
          const filterValue = tab.getAttribute('data-filter');
          if (filterValue && filterValue !== 'all') {
            categoryCounts[filterValue] = 0;
          }
        });

        // Count actual photos in each category
        galleryItems.forEach(item => {
          const category = item.getAttribute('data-category');
          if (category && category in categoryCounts) {
            const count = categoryCounts[category];
            if (count !== undefined) {
              categoryCounts[category] = count + 1;
            }
          }
        });

        // Sort categories by count (descending)
        const sortedCategories = Object.entries(categoryCounts)
          .sort(([,a], [,b]) => (b as number) - (a as number))
          .map(([category]) => category);

        // Get tabs to sort (excluding "All" tab)
        const tabsToSort = Array.from(filterTabs).filter(tab =>
          tab.getAttribute('data-filter') !== 'all'
        );

        // Remove all tabs except "All"
        tabsToSort.forEach(tab => tab.remove());

        // Re-add tabs in sorted order
        sortedCategories.forEach(categoryValue => {
          const matchingTab = tabsToSort.find(tab =>
            tab.getAttribute('data-filter') === categoryValue
          );
          if (matchingTab && filterContainer) {
            filterContainer.appendChild(matchingTab);
          }
        });

        devLog('Filter tabs sorted by photo count:', categoryCounts);
      }

      // Apply dynamic sorting
      sortFiltersByPhotoCount();

      // Note: CSS columns layout automatically creates the masonry effect

      // Gallery and filter functionality
      const filterTabs = document.querySelectorAll('.filter-tab');
      const galleryItems = document.querySelectorAll('.gallery-item');

      // Lightbox elements
      const lightbox = document.getElementById('lightbox');
      const lightboxImage = document.getElementById('lightboxImage');
      const lightboxClose = document.getElementById('lightboxClose');
      const lightboxPrev = document.getElementById('lightboxPrev');
      const lightboxNext = document.getElementById('lightboxNext');

      // Metadata elements
      const metadataFileNumber = document.getElementById('metadataFileNumber');
      const categoryDisplay = document.getElementById('categoryDisplay');
      const categoryDropdownBtn = document.getElementById('categoryDropdownBtn');
      const categoryDropdownMenu = document.getElementById('categoryDropdownMenu');
      const metadataCamera = document.getElementById('metadataCamera');
      const metadataLens = document.getElementById('metadataLens');
      const metadataFocalLength = document.getElementById('metadataFocalLength');
      const metadataAperture = document.getElementById('metadataAperture');
      const metadataShutterSpeed = document.getElementById('metadataShutterSpeed');
      const metadataISO = document.getElementById('metadataISO');
      const metadataDate = document.getElementById('metadataDate');
      const metadataTime = document.getElementById('metadataTime');
      const metadataLocationItem = document.getElementById('metadataLocationItem');
      const metadataLocationDisplay = document.getElementById('metadataLocationDisplay');
      const metadataLocationInput = document.getElementById('metadataLocationInput');
      const metadataLensItem = document.getElementById('metadataLensItem');
      const metadataLensDisplay = document.getElementById('metadataLensDisplay');
      const metadataLensInput = document.getElementById('metadataLensInput');

      let currentImageIndex = 0;
      let visibleItems = [...galleryItems];

      // Image cache to keep preloaded images in memory for instant access
      const imageCache = new Map();

      // Filter functionality
      filterTabs.forEach(tab => {
        tab.addEventListener('click', () => {
          filterTabs.forEach(t => t.classList.remove('active'));
          tab.classList.add('active');

          const filterValue = tab.getAttribute('data-filter');
          visibleItems = [];

          if (filterValue === 'all') {
            // For "All" filter, show all items from all categories
            devLog('Starting "All" filter - showing all items from all categories');

            galleryItems.forEach((item) => {
              item.classList.remove('hidden');
              visibleItems.push(item);
              // Remove animation delays to prevent blinking
              (item as HTMLElement).style.animation = 'none';
              (item as HTMLElement).offsetHeight;
              (item as HTMLElement).style.animation = 'fadeInScale 0.6s ease-out';
            });
          } else {
            // For specific category filters, show all items in that category
            galleryItems.forEach((item) => {
              const itemCategory = item.getAttribute('data-category');

              if (itemCategory === filterValue) {
                item.classList.remove('hidden');
                visibleItems.push(item);
                // Remove animation delays to prevent blinking
                (item as HTMLElement).style.animation = 'none';
                (item as HTMLElement).offsetHeight;
                (item as HTMLElement).style.animation = 'fadeInScale 0.6s ease-out';
              } else {
                item.classList.add('hidden');
              }
            });
          }

          // Reinitialize image loading for newly visible images
          setTimeout(() => {
            observeNewImages();
          }, 100);
        });
      });

      // Lightbox functionality
      function openLightbox(index: number) {
        const item = visibleItems[index];
        if (!item) return;

        const img = item.querySelector('img') as HTMLImageElement;
        const titleElement = item.querySelector('h3');
        const title = titleElement ? titleElement.textContent || '' : '';

        currentImageIndex = index;

        // Get image source from data-href instead of relying on lazy-loaded src
        const itemHref = item.getAttribute('data-href');

        if (lightboxImage && itemHref) {
          // Keep full opacity for instant transition - no loading indicator
          lightboxImage.style.opacity = '1';

          // Always update the src immediately for instant display
          // The browser cache will handle this quickly if preloaded
          (lightboxImage as HTMLImageElement).src = itemHref;
          (lightboxImage as HTMLImageElement).alt = img.alt || title;

          // Check if this is a portrait/vertical photo and if we're on mobile
          const orientation = item.getAttribute('data-orientation');
          const isMobile = window.innerWidth <= 768;

          if (isMobile && orientation === 'portrait') {
            lightboxImage.classList.add('vertical-portrait');
          } else {
            lightboxImage.classList.remove('vertical-portrait');
          }

          // Cache current image if not already cached
          if (!imageCache.has(itemHref)) {
            const newImg = new Image();
            newImg.src = itemHref;
            imageCache.set(itemHref, newImg);
            newImg.decode().catch(() => {/* ignore */});
          }

          // EXTREMELY aggressively preload ALL images for instant random navigation
          // Both arrows go to random photos, so we need all images preloaded
          // Preload in priority order: nearby images first, then all others

          // First priority: preload nearby 5 images immediately for quick access
          for (let i = 1; i <= 5; i++) {
            const nextIndex = (index + i) % visibleItems.length;
            if (visibleItems[nextIndex]) {
              const nextHref = visibleItems[nextIndex].getAttribute('data-href');
              if (nextHref && !imageCache.has(nextHref)) {
                const preloadImg = new Image();
                preloadImg.src = nextHref;
                imageCache.set(nextHref, preloadImg);
                preloadImg.decode().catch(() => {/* ignore */});
              }
            }
          }

          // Second priority: preload ALL other images for instant random navigation
          // Use requestIdleCallback if available, otherwise immediate
          const preloadAll = () => {
            visibleItems.forEach((item: any, idx: number) => {
              if (idx !== index) { // Skip current image
                const href = item.getAttribute('data-href');
                if (href && !imageCache.has(href)) {
                  const preloadImg = new Image();
                  preloadImg.src = href;
                  imageCache.set(href, preloadImg);
                  preloadImg.decode().catch(() => {/* ignore */});
                }
              }
            });
          };

          // Start preloading immediately in background
          if ('requestIdleCallback' in window) {
            requestIdleCallback(preloadAll);
          } else {
            setTimeout(preloadAll, 0);
          }
        }

        // Get real metadata from gallery item (reuse itemHref from above)
        const galleryItemData = window.galleryData.find((galleryItem: any) => galleryItem.href === itemHref);

        // Set file number - extract just the number from the label
        if (metadataFileNumber && galleryItemData) {
          const label = galleryItemData.label || title;
          // Extract the number from labels like "IMG 8413", "DSC02870", etc.
          const cleanNumber = label.replace(/^(DSC_?|IMG_?|DSCF_?|DSCN_?|[A-Z]{2,}_?)\s*/, '').replace(/[-_\s]/g, '');
          metadataFileNumber.textContent = cleanNumber;
        }

        // Set category value in metadata section
        if (categoryDisplay && galleryItemData) {
          const primaryCategory = galleryItemData.category || 'all';
          const additionalCategories = galleryItemData.additionalCategories || [];

          // Clear and update category display
          categoryDisplay.innerHTML = '';

          // Add primary category tag
          const primaryTag = document.createElement('span');
          primaryTag.className = 'category-tag';
          primaryTag.textContent = primaryCategory.charAt(0).toUpperCase() + primaryCategory.slice(1);
          categoryDisplay.appendChild(primaryTag);

          // Add additional category tags
          additionalCategories.forEach((cat: string) => {
            const tag = document.createElement('span');
            tag.className = 'category-tag';
            tag.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categoryDisplay.appendChild(tag);
          });
        }

        if (galleryItemData && galleryItemData.metadata) {
          const metadata = galleryItemData.metadata;
          // Helper function to display "---" for unknown/empty values
          const displayValue = (value: string) => {
            return (value && value !== 'Unknown' && value !== 'Unknown Camera' && value !== 'Unknown Lens') ? value : '---';
          };
          if (metadataCamera) metadataCamera.textContent = displayValue(metadata.camera);
          if (metadataLens) metadataLens.textContent = displayValue(metadata.lens);
          if (metadataFocalLength) metadataFocalLength.textContent = displayValue(metadata.focalLength);
          if (metadataAperture) metadataAperture.textContent = displayValue(metadata.aperture);
          if (metadataShutterSpeed) metadataShutterSpeed.textContent = displayValue(metadata.shutterSpeed);
          if (metadataISO) metadataISO.textContent = displayValue(metadata.iso);
          if (metadataDate) metadataDate.textContent = displayValue(metadata.date);
          if (metadataTime) metadataTime.textContent = displayValue(metadata.time);
        } else {
          // Fallback to default values if metadata not found
          if (metadataCamera) metadataCamera.textContent = '---';
          if (metadataLens) metadataLens.textContent = '---';
          if (metadataFocalLength) metadataFocalLength.textContent = '---';
          if (metadataAperture) metadataAperture.textContent = '---';
          if (metadataShutterSpeed) metadataShutterSpeed.textContent = '---';
          if (metadataISO) metadataISO.textContent = '---';
          if (metadataDate) metadataDate.textContent = '---';
          if (metadataTime) metadataTime.textContent = '---';
        }

        // Handle location metadata (development mode only for editing)
        // Check if we're in dev mode AND not in prod preview mode
        const isProdPreviewMode = localStorage.getItem('prodPreviewMode') === 'true';
        const isDev = import.meta.env.DEV && !isProdPreviewMode;
        console.log('ðŸ” Mode check:', {
          'import.meta.env.DEV': import.meta.env.DEV,
          isProdPreviewMode,
          isDev,
          'body has prod-preview-mode class': document.body.classList.contains('prod-preview-mode')
        });
        const imageLabel = galleryItemData ? galleryItemData.label : '';

        // Load location from localStorage or gallery data
        const savedLocations = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
        let location = savedLocations[imageLabel] || (galleryItemData?.metadata?.location) || '';

        // Helper to check if a location value is valid (not a placeholder)
        const isValidLocation = (location: string) => {
          return location &&
                 location.trim() !== '' &&
                 location !== '----' &&
                 location !== 'Unknown';
        };

        // Helper to check if a lens value is valid (not a placeholder)
        const isValidLens = (lens: string) => {
          return lens &&
                 lens.trim() !== '' &&
                 lens !== 'Unknown' &&
                 lens !== 'Unknown Lens' &&
                 lens !== '----' &&
                 lens !== '---';
        };

        // Helper function to get all unique locations
        function getAllLocations(): string[] {
          const locations = new Set<string>();

          // Add from localStorage
          const saved = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
          Object.values(saved).forEach((loc: any) => {
            if (loc && typeof loc === 'string') locations.add(loc);
          });

          // Add from gallery data
          galleryItems.forEach((item: any) => {
            if (item.metadata?.location) {
              locations.add(item.metadata.location);
            }
          });

          return Array.from(locations).sort();
        }

        // Helper function to update the datalist
        function updateLocationDatalist() {
          const datalist = document.getElementById('locationSuggestions');
          if (!datalist || !isDev) return;

          datalist.innerHTML = '';

          // Pre-suggested locations in "City Name, Country Name" format
          const suggestedLocations = [
            // India
            'Kolkata, India',
            'Mumbai, India',
            'Delhi, India',
            'Bangalore, India',
            'Chennai, India',
            'Hyderabad, India',
            'Jaipur, India',
            'Goa, India',
            'Agra, India',
            'Varanasi, India',
            'Udaipur, India',
            'Rishikesh, India',
            'Darjeeling, India',
            'Shimla, India',
            'Manali, India',
            'Leh, India',
            'Ladakh, India',
            'Srinagar, India',
            'Pondicherry, India',
            'Cochin, India',
            'Kochi, India',
            'Mysore, India',
            'Ooty, India',
            'Munnar, India',
            'Hampi, India',
            'Khajuraho, India',
            'Pushkar, India',
            'Jodhpur, India',
            'Jaisalmer, India',
            'Amritsar, India',
            'McLeod Ganj, India',
            'Spiti Valley, India',
            'Nainital, India',
            'Mussoorie, India',
            'Alleppey, India',
            'Varkala, India',
            'Gokarna, India',
            'Kodaikanal, India',
            'Andaman Islands, India',
            'Port Blair, India',
            'Havelock Island, India',
            'Sikkim, India',
            'Gangtok, India',
            'Auli, India',
            'Kasol, India',
            'Bir Billing, India',

            // USA
            'New York City, USA',
            'Los Angeles, USA',
            'San Francisco, USA',
            'Chicago, USA',
            'Boston, USA',
            'Seattle, USA',
            'Miami, USA',
            'Las Vegas, USA',
            'Washington DC, USA',
            'Portland, USA',
            'Austin, USA',
            'Denver, USA',
            'Nashville, USA',
            'New Orleans, USA',
            'San Diego, USA',
            'Philadelphia, USA',
            'Phoenix, USA',
            'Grand Canyon, USA',
            'Yosemite, USA',
            'Yellowstone, USA',
            'Zion National Park, USA',
            'Antelope Canyon, USA',
            'Monument Valley, USA',
            'Big Sur, USA',
            'Lake Tahoe, USA',
            'Aspen, USA',
            'Sedona, USA',
            'Key West, USA',
            'Santa Fe, USA',
            'Charleston, USA',
            'Savannah, USA',
            'Napa Valley, USA',
            'Honolulu, USA',
            'Maui, USA',

            // United Kingdom
            'London, United Kingdom',
            'Edinburgh, United Kingdom',
            'Glasgow, United Kingdom',
            'Manchester, United Kingdom',
            'Liverpool, United Kingdom',
            'Bath, United Kingdom',
            'Oxford, United Kingdom',
            'Cambridge, United Kingdom',
            'York, United Kingdom',
            'Brighton, United Kingdom',
            'Cornwall, United Kingdom',
            'Lake District, United Kingdom',
            'Cotswolds, United Kingdom',
            'Stonehenge, United Kingdom',
            'Isle of Skye, United Kingdom',
            'Belfast, United Kingdom',
            'Cardiff, United Kingdom',

            // France
            'Paris, France',
            'Nice, France',
            'Marseille, France',
            'Lyon, France',
            'Bordeaux, France',
            'Cannes, France',
            'Monaco, France',
            'Versailles, France',
            'Mont Saint-Michel, France',
            'Provence, France',
            'Chamonix, France',
            'Annecy, France',
            'Strasbourg, France',
            'Colmar, France',
            'Loire Valley, France',
            'Normandy, France',
            'Avignon, France',
            'Saint-Tropez, France',

            // Italy
            'Rome, Italy',
            'Venice, Italy',
            'Florence, Italy',
            'Milan, Italy',
            'Naples, Italy',
            'Pisa, Italy',
            'Verona, Italy',
            'Bologna, Italy',
            'Turin, Italy',
            'Genoa, Italy',
            'Amalfi Coast, Italy',
            'Positano, Italy',
            'Cinque Terre, Italy',
            'Siena, Italy',
            'Lucca, Italy',
            'Pompeii, Italy',
            'Capri, Italy',
            'Lake Como, Italy',
            'Dolomites, Italy',
            'Sicily, Italy',
            'Palermo, Italy',
            'Sardinia, Italy',
            'San Gimignano, Italy',
            'Matera, Italy',
            'Assisi, Italy',

            // Spain
            'Barcelona, Spain',
            'Madrid, Spain',
            'Seville, Spain',
            'Valencia, Spain',
            'Granada, Spain',
            'Bilbao, Spain',
            'San Sebastian, Spain',
            'Malaga, Spain',
            'Ibiza, Spain',
            'Mallorca, Spain',
            'Toledo, Spain',
            'Cordoba, Spain',
            'Ronda, Spain',
            'Segovia, Spain',
            'Santiago de Compostela, Spain',
            'Salamanca, Spain',

            // Germany
            'Berlin, Germany',
            'Munich, Germany',
            'Hamburg, Germany',
            'Frankfurt, Germany',
            'Cologne, Germany',
            'Dresden, Germany',
            'Heidelberg, Germany',
            'Nuremberg, Germany',
            'Rothenburg, Germany',
            'Neuschwanstein Castle, Germany',
            'Black Forest, Germany',
            'Rhine Valley, Germany',
            'Garmisch-Partenkirchen, Germany',

            // Austria
            'Vienna, Austria',
            'Salzburg, Austria',
            'Innsbruck, Austria',
            'Hallstatt, Austria',
            'Graz, Austria',
            'Zell am See, Austria',
            'KitzbÃ¼hel, Austria',
            'St. Anton, Austria',

            // Switzerland
            'Zurich, Switzerland',
            'Geneva, Switzerland',
            'Lucerne, Switzerland',
            'Bern, Switzerland',
            'Interlaken, Switzerland',
            'Zermatt, Switzerland',
            'Lausanne, Switzerland',
            'Grindelwald, Switzerland',
            'Jungfraujoch, Switzerland',
            'St. Moritz, Switzerland',

            // The Netherlands
            'Amsterdam, The Netherlands',
            'Rotterdam, The Netherlands',
            'The Hague, The Netherlands',
            'Utrecht, The Netherlands',
            'Giethoorn, The Netherlands',
            'Kinderdijk, The Netherlands',

            // Czech Republic
            'Prague, Czech Republic',
            'ÄŒeskÃ½ Krumlov, Czech Republic',
            'Brno, Czech Republic',
            'Karlovy Vary, Czech Republic',

            // Hungary
            'Budapest, Hungary',

            // Greece
            'Athens, Greece',
            'Santorini, Greece',
            'Mykonos, Greece',
            'Crete, Greece',
            'Rhodes, Greece',
            'Corfu, Greece',
            'Delphi, Greece',
            'Meteora, Greece',
            'Thessaloniki, Greece',

            // Turkey
            'Istanbul, Turkey',
            'Cappadocia, Turkey',
            'Antalya, Turkey',
            'Ephesus, Turkey',
            'Pamukkale, Turkey',
            'Bodrum, Turkey',

            // Portugal
            'Lisbon, Portugal',
            'Porto, Portugal',
            'Algarve, Portugal',
            'Sintra, Portugal',
            'Madeira, Portugal',
            'Azores, Portugal',

            // Scandinavia
            'Stockholm, Sweden',
            'Gothenburg, Sweden',
            'Copenhagen, Denmark',
            'Oslo, Norway',
            'Bergen, Norway',
            'Lofoten Islands, Norway',
            'TromsÃ¸, Norway',
            'Helsinki, Finland',
            'Lapland, Finland',
            'Reykjavik, Iceland',
            'Blue Lagoon, Iceland',
            'JÃ¶kulsÃ¡rlÃ³n, Iceland',

            // Ireland
            'Dublin, Ireland',
            'Galway, Ireland',
            'Cork, Ireland',
            'Cliffs of Moher, Ireland',
            'Ring of Kerry, Ireland',

            // Belgium
            'Brussels, Belgium',
            'Bruges, Belgium',
            'Ghent, Belgium',
            'Antwerp, Belgium',

            // Luxembourg
            'Luxembourg City, Luxembourg',

            // Poland
            'Warsaw, Poland',
            'Krakow, Poland',
            'Gdansk, Poland',
            'Zakopane, Poland',

            // Croatia
            'Dubrovnik, Croatia',
            'Split, Croatia',
            'Zagreb, Croatia',
            'Plitvice Lakes, Croatia',
            'Hvar, Croatia',

            // Romania
            'Bucharest, Romania',
            'Brasov, Romania',
            'Cluj-Napoca, Romania',
            'TimiÈ™oara, Romania',
            'Sibiu, Romania',
            'SighiÈ™oara, Romania',
            'Bran, Romania',
            'PeleÈ™ Castle, Romania',

            // Bulgaria
            'Sofia, Bulgaria',
            'Plovdiv, Bulgaria',
            'Varna, Bulgaria',
            'Burgas, Bulgaria',
            'Veliko Tarnovo, Bulgaria',
            'Rila Monastery, Bulgaria',

            // Slovenia
            'Ljubljana, Slovenia',
            'Bled, Slovenia',
            'Piran, Slovenia',
            'Maribor, Slovenia',
            'Postojna Cave, Slovenia',

            // Serbia
            'Belgrade, Serbia',
            'Novi Sad, Serbia',
            'NiÅ¡, Serbia',

            // Bosnia and Herzegovina
            'Sarajevo, Bosnia and Herzegovina',
            'Mostar, Bosnia and Herzegovina',

            // Albania
            'Tirana, Albania',
            'Berat, Albania',
            'GjirokastÃ«r, Albania',
            'Saranda, Albania',

            // North Macedonia
            'Skopje, North Macedonia',
            'Ohrid, North Macedonia',

            // Montenegro
            'Kotor, Montenegro',
            'Budva, Montenegro',
            'Podgorica, Montenegro',

            // Slovakia
            'Bratislava, Slovakia',
            'KoÅ¡ice, Slovakia',
            'Tatras, Slovakia',

            // Estonia
            'Tallinn, Estonia',
            'Tartu, Estonia',
            'PÃ¤rnu, Estonia',

            // Latvia
            'Riga, Latvia',
            'JÅ«rmala, Latvia',
            'Sigulda, Latvia',

            // Lithuania
            'Vilnius, Lithuania',
            'Kaunas, Lithuania',
            'KlaipÄ—da, Lithuania',
            'Trakai, Lithuania',

            // Georgia
            'Tbilisi, Georgia',
            'Batumi, Georgia',
            'Mtskheta, Georgia',
            'Kazbegi, Georgia',
            'Svaneti, Georgia',

            // Armenia
            'Yerevan, Armenia',
            'Gyumri, Armenia',
            'Dilijan, Armenia',
            'Lake Sevan, Armenia',

            // Azerbaijan
            'Baku, Azerbaijan',
            'Sheki, Azerbaijan',
            'Gabala, Azerbaijan',

            // Ukraine
            'Kyiv, Ukraine',
            'Lviv, Ukraine',
            'Odesa, Ukraine',
            'Kharkiv, Ukraine',

            // Moldova
            'ChiÈ™inÄƒu, Moldova',
            'Orheiul Vechi, Moldova',

            // Cyprus
            'Nicosia, Cyprus',
            'Limassol, Cyprus',
            'Paphos, Cyprus',
            'Larnaca, Cyprus',

            // Malta
            'Valletta, Malta',
            'Mdina, Malta',
            'Gozo, Malta',

            // Belarus
            'Minsk, Belarus',
            'Brest, Belarus',
            'Grodno, Belarus',

            // Kosovo
            'Pristina, Kosovo',
            'Prizren, Kosovo',

            // Andorra
            'Andorra la Vella, Andorra',

            // Liechtenstein
            'Vaduz, Liechtenstein',

            // San Marino
            'San Marino, San Marino',

            // Monaco
            'Monte Carlo, Monaco',

            // UAE & Middle East
            'Dubai, UAE',
            'Abu Dhabi, UAE',
            'Doha, Qatar',
            'Muscat, Oman',
            'Jerusalem, Israel',
            'Tel Aviv, Israel',
            'Petra, Jordan',
            'Wadi Rum, Jordan',
            'Beirut, Lebanon',

            // Asia Pacific
            'Singapore, Singapore',
            'Hong Kong, China',
            'Beijing, China',
            'Shanghai, China',
            'Xi\'an, China',
            'Guilin, China',
            'Yangshuo, China',
            'Zhangjiajie, China',
            'Tokyo, Japan',
            'Kyoto, Japan',
            'Osaka, Japan',
            'Hiroshima, Japan',
            'Nara, Japan',
            'Hakone, Japan',
            'Nikko, Japan',
            'Takayama, Japan',
            'Seoul, South Korea',
            'Busan, South Korea',
            'Jeju Island, South Korea',
            'Bangkok, Thailand',
            'Chiang Mai, Thailand',
            'Phuket, Thailand',
            'Krabi, Thailand',
            'Ayutthaya, Thailand',
            'Bali, Indonesia',
            'Jakarta, Indonesia',
            'Yogyakarta, Indonesia',
            'Lombok, Indonesia',
            'Komodo Island, Indonesia',
            'Kuala Lumpur, Malaysia',
            'Penang, Malaysia',
            'Langkawi, Malaysia',
            'Hanoi, Vietnam',
            'Ho Chi Minh City, Vietnam',
            'Halong Bay, Vietnam',
            'Hoi An, Vietnam',
            'Hue, Vietnam',
            'Sapa, Vietnam',
            'Phnom Penh, Cambodia',
            'Siem Reap, Cambodia',
            'Angkor Wat, Cambodia',
            'Luang Prabang, Laos',
            'Vientiane, Laos',
            'Manila, Philippines',
            'Boracay, Philippines',
            'Palawan, Philippines',
            'Cebu, Philippines',
            'Taipei, Taiwan',
            'Yangon, Myanmar',
            'Bagan, Myanmar',

            // South Asia
            'Kathmandu, Nepal',
            'Pokhara, Nepal',
            'Everest Base Camp, Nepal',
            'Colombo, Sri Lanka',
            'Kandy, Sri Lanka',
            'Galle, Sri Lanka',
            'Ella, Sri Lanka',
            'Dhaka, Bangladesh',
            'Thimphu, Bhutan',
            'Paro, Bhutan',
            'Male, Maldives',

            // Australia & New Zealand
            'Sydney, Australia',
            'Melbourne, Australia',
            'Brisbane, Australia',
            'Perth, Australia',
            'Adelaide, Australia',
            'Cairns, Australia',
            'Great Barrier Reef, Australia',
            'Uluru, Australia',
            'Gold Coast, Australia',
            'Whitsundays, Australia',
            'Auckland, New Zealand',
            'Wellington, New Zealand',
            'Queenstown, New Zealand',
            'Christchurch, New Zealand',
            'Rotorua, New Zealand',
            'Milford Sound, New Zealand',

            // Canada
            'Toronto, Canada',
            'Vancouver, Canada',
            'Montreal, Canada',
            'Quebec City, Canada',
            'Ottawa, Canada',
            'Calgary, Canada',
            'Banff, Canada',
            'Jasper, Canada',
            'Whistler, Canada',
            'Niagara Falls, Canada',
            'Victoria, Canada',

            // Mexico & Central America
            'Mexico City, Mexico',
            'Cancun, Mexico',
            'Playa del Carmen, Mexico',
            'Tulum, Mexico',
            'Guadalajara, Mexico',
            'Oaxaca, Mexico',
            'San Miguel de Allende, Mexico',
            'Guanajuato, Mexico',
            'Guatemala City, Guatemala',
            'Antigua, Guatemala',
            'San Jose, Costa Rica',
            'Panama City, Panama',

            // South America
            'Buenos Aires, Argentina',
            'Patagonia, Argentina',
            'Mendoza, Argentina',
            'Ushuaia, Argentina',
            'Rio de Janeiro, Brazil',
            'SÃ£o Paulo, Brazil',
            'Iguazu Falls, Brazil',
            'Salvador, Brazil',
            'Brasilia, Brazil',
            'Lima, Peru',
            'Cusco, Peru',
            'Machu Picchu, Peru',
            'Arequipa, Peru',
            'Santiago, Chile',
            'Valparaiso, Chile',
            'Cartagena, Colombia',
            'Bogota, Colombia',
            'Medellin, Colombia',
            'Quito, Ecuador',
            'Galapagos Islands, Ecuador',
            'La Paz, Bolivia',
            'Uyuni Salt Flats, Bolivia',

            // Africa
            'Cape Town, South Africa',
            'Johannesburg, South Africa',
            'Kruger National Park, South Africa',
            'Cairo, Egypt',
            'Luxor, Egypt',
            'Giza, Egypt',
            'Marrakech, Morocco',
            'Fez, Morocco',
            'Casablanca, Morocco',
            'Chefchaouen, Morocco',
            'Nairobi, Kenya',
            'Masai Mara, Kenya',
            'Zanzibar, Tanzania',
            'Serengeti, Tanzania',
            'Victoria Falls, Zimbabwe',
            'Mauritius, Mauritius',
            'Seychelles, Seychelles',

            // Russia
            'Moscow, Russia',
            'St Petersburg, Russia',
            'Kazan, Russia',
            'Sochi, Russia'
          ];

          // Get existing locations from the gallery
          const existingLocations = getAllLocations();

          // Combine suggested and existing locations, remove duplicates
          const allLocations = Array.from(new Set([...suggestedLocations, ...existingLocations])).sort();

          allLocations.forEach((loc: string) => {
            const option = document.createElement('option');
            option.value = loc;
            datalist.appendChild(option);
          });
        }

        const locationInputContainer = document.querySelector('.location-input-container') as HTMLElement;
        const locationShortcuts = document.getElementById('locationShortcuts') as HTMLElement;

        // Function to populate location shortcut buttons
        function populateLocationShortcuts() {
          if (!locationShortcuts) return;

          // Get the most frequently used locations from localStorage
          const saved = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
          const locationCounts: Record<string, number> = {};

          Object.values(saved).forEach((loc: any) => {
            const location = loc as string;
            locationCounts[location] = (locationCounts[location] || 0) + 1;
          });

          // Sort by frequency and get top 5
          const topLocations = Object.entries(locationCounts)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 5)
            .map(([loc]) => loc);

          // Clear existing buttons
          locationShortcuts.innerHTML = '';

          // Add shortcut buttons
          topLocations.forEach((loc: string) => {
            const btn = document.createElement('button');
            btn.className = 'location-shortcut-btn';
            btn.textContent = loc;
            btn.onclick = () => {
              (metadataLocationInput as HTMLInputElement).value = loc;
              (metadataLocationInput as HTMLInputElement).dispatchEvent(new Event('change'));
            };
            locationShortcuts.appendChild(btn);
          });

          // Show shortcuts if there are any
          if (topLocations.length > 0) {
            locationShortcuts.style.display = 'flex';
          } else {
            locationShortcuts.style.display = 'none';
          }
        }

        if (metadataLocationItem && metadataLocationDisplay) {
          if (isValidLocation(location) || isDev) {
            // Show location item if valid location exists OR if in development
            metadataLocationItem.style.display = 'flex';

            if (isDev && metadataLocationInput) {
              // In development: show input container, hide display
              metadataLocationDisplay.style.display = 'none';
              if (locationInputContainer) locationInputContainer.style.display = 'flex';
              (metadataLocationInput as HTMLInputElement).value = location;

              // Populate datalist with all available locations
              updateLocationDatalist();

              // Populate location shortcuts
              populateLocationShortcuts();

              // Save location on input change (blur or Enter key)
              metadataLocationInput.onchange = () => {
                const newLocation = (metadataLocationInput as HTMLInputElement).value.trim();
                if (newLocation) {
                  savedLocations[imageLabel] = newLocation;
                  localStorage.setItem('photoLocations', JSON.stringify(savedLocations));
                  // Update datalist to include the new location
                  updateLocationDatalist();
                  // Update shortcuts
                  populateLocationShortcuts();
                } else {
                  delete savedLocations[imageLabel];
                  localStorage.setItem('photoLocations', JSON.stringify(savedLocations));
                  // Hide the item if location is empty and not on localhost display mode
                  if (!isDev) {
                    metadataLocationItem.style.display = 'none';
                  }
                  // Update shortcuts
                  populateLocationShortcuts();
                }
                // Update dropdown after location change
                updateLocationDropdown(newLocation, imageLabel);
              };

              // Also handle Enter key to immediately save and update
              metadataLocationInput.onkeydown = (e: KeyboardEvent) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  (metadataLocationInput as HTMLInputElement).blur();
                  (metadataLocationInput as HTMLInputElement).focus();
                }
              };

              // Location Manager functionality
              const manageLocationsBtn = document.getElementById('manageLocationsBtn');
              const locationManagerModal = document.getElementById('locationManagerModal');
              const closeLocationManager = document.getElementById('closeLocationManager');
              const locationManagerList = document.getElementById('locationManagerList');

              function openLocationManager() {
                if (!locationManagerModal || !locationManagerList) return;

                // Populate the list
                const locations = getAllLocations();
                const savedLocations = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});

                locationManagerList.innerHTML = '';

                if (locations.length === 0) {
                  locationManagerList.innerHTML = '<div class="location-manager-empty">No locations saved yet. Add locations to photos to manage them here.</div>';
                } else {
                  locations.forEach((loc: string) => {
                    // Count how many photos use this location
                    const count = Object.values(savedLocations).filter((l: any) => l === loc).length;

                    const item = document.createElement('div');
                    item.className = 'location-manager-item';
                    item.innerHTML = `
                      <input type="text" class="location-manager-item-name readonly" value="${loc}" data-original="${loc}" readonly>
                      <span class="location-manager-item-count">${count} photo${count !== 1 ? 's' : ''}</span>
                      <button class="location-manager-btn edit" data-location="${loc}">Edit</button>
                      <button class="location-manager-btn delete" data-location="${loc}">Delete</button>
                    `;

                    // Edit button handler
                    const editBtn = item.querySelector('.edit') as HTMLButtonElement;
                    const deleteBtn = item.querySelector('.delete') as HTMLButtonElement;
                    const nameInput = item.querySelector('.location-manager-item-name') as HTMLInputElement;

                    editBtn.onclick = () => {
                      if (editBtn.textContent === 'Edit') {
                        // Enter edit mode
                        nameInput.readOnly = false;
                        nameInput.classList.remove('readonly');
                        nameInput.select();
                        editBtn.textContent = 'Save';
                        deleteBtn.disabled = true;
                        deleteBtn.style.opacity = '0.5';
                      } else {
                        // Save changes
                        const oldLocation = nameInput.dataset.original || '';
                        const newLocation = nameInput.value.trim();

                        if (newLocation && newLocation !== oldLocation) {
                          // Update all photos with this location
                          const saved = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
                          Object.keys(saved).forEach((label: string) => {
                            if (saved[label] === oldLocation) {
                              saved[label] = newLocation;
                            }
                          });
                          localStorage.setItem('photoLocations', JSON.stringify(saved));

                          // Update datalist and current photo if needed
                          updateLocationDatalist();
                          if (location === oldLocation) {
                            location = newLocation;
                            (metadataLocationInput as HTMLInputElement).value = newLocation;
                            savedLocations[imageLabel] = newLocation;
                            updateLocationDropdown(newLocation, imageLabel);
                          }

                          // Update shortcuts
                          populateLocationShortcuts();

                          // Refresh the manager list
                          openLocationManager();
                        } else {
                          nameInput.value = oldLocation;
                          nameInput.readOnly = true;
                          nameInput.classList.add('readonly');
                          editBtn.textContent = 'Edit';
                          deleteBtn.disabled = false;
                          deleteBtn.style.opacity = '1';
                        }
                      }
                    };

                    // Delete button handler
                    deleteBtn.onclick = () => {
                      if (confirm(`Delete location "${loc}"? This will remove it from ${count} photo${count !== 1 ? 's' : ''}.`)) {
                        // Remove from all photos
                        const saved = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLocations'), {});
                        Object.keys(saved).forEach((label: string) => {
                          if (saved[label] === loc) {
                            delete saved[label];
                          }
                        });
                        localStorage.setItem('photoLocations', JSON.stringify(saved));

                        // Update datalist and current photo if needed
                        updateLocationDatalist();
                        if (location === loc) {
                          location = '';
                          (metadataLocationInput as HTMLInputElement).value = '';
                          delete savedLocations[imageLabel];
                          updateLocationDropdown('', imageLabel);
                        }

                        // Update shortcuts
                        populateLocationShortcuts();

                        // Refresh the manager list
                        openLocationManager();
                      }
                    };

                    locationManagerList.appendChild(item);
                  });
                }

                locationManagerModal.style.display = 'flex';
              }

              function closeLocationManagerModal() {
                if (locationManagerModal) {
                  locationManagerModal.style.display = 'none';
                }
              }

              if (manageLocationsBtn) {
                manageLocationsBtn.onclick = openLocationManager;
              }

              if (closeLocationManager) {
                closeLocationManager.onclick = closeLocationManagerModal;
              }

              // Close modal when clicking outside
              if (locationManagerModal) {
                locationManagerModal.onclick = (e: MouseEvent) => {
                  if (e.target === locationManagerModal) {
                    closeLocationManagerModal();
                  }
                };
              }
            } else {
              // Not in development: show display only if location exists
              metadataLocationDisplay.style.display = 'inline';
              // Format location to display City on one line and Country on the next
              metadataLocationDisplay.innerHTML = location.replace(', ', '<br>');
            }
          } else {
            // No location and not localhost: hide completely
            metadataLocationItem.style.display = 'none';
          }
        }

        // Location dropdown feature removed for production
        function updateLocationDropdown(_currentLocation: string, _currentImageLabel: string) {
          // Feature disabled - no-op function
          return;
        }

        // Handle lens metadata (localhost only for editing)
        // Load lens from localStorage or gallery data
        const savedLenses = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});
        let lens = savedLenses[imageLabel] || (galleryItemData?.metadata?.lens) || '';

        // Helper function to get all unique lenses
        function getAllLenses(): string[] {
          const lenses = new Set<string>();

          // Add from localStorage
          const saved = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});
          Object.values(saved).forEach((lensItem: any) => {
            if (lensItem && typeof lensItem === 'string' && isValidLens(lensItem)) {
              lenses.add(lensItem);
            }
          });

          // Add from gallery data
          galleryItems.forEach((item: any) => {
            if (item.metadata?.lens && isValidLens(item.metadata.lens)) {
              lenses.add(item.metadata.lens);
            }
          });

          return Array.from(lenses).sort();
        }

        // Helper function to update the datalist
        function updateLensDatalist() {
          const datalist = document.getElementById('lensSuggestions');
          if (!datalist || !isDev) return;

          datalist.innerHTML = '';

          // Get existing lenses from the gallery and localStorage only
          const existingLenses = getAllLenses();

          existingLenses.forEach((lensItem: string) => {
            const option = document.createElement('option');
            option.value = lensItem;
            datalist.appendChild(option);
          });
        }

        const lensInputContainer = document.querySelector('.lens-input-container') as HTMLElement;

        if (metadataLensItem && metadataLensDisplay) {
          if (isValidLens(lens) || isDev) {
            // Show lens item if valid lens exists OR if in development
            metadataLensItem.style.display = 'flex';

            if (isDev && metadataLensInput) {
              // In development: show input container, hide display
              metadataLensDisplay.style.display = 'none';
              if (lensInputContainer) lensInputContainer.style.display = 'flex';
              (metadataLensInput as HTMLInputElement).value = lens;

              // Populate datalist with all available lenses
              updateLensDatalist();

              // Save lens on input change (blur or Enter key)
              metadataLensInput.onchange = () => {
                const newLens = (metadataLensInput as HTMLInputElement).value.trim();
                if (newLens) {
                  savedLenses[imageLabel] = newLens;
                  localStorage.setItem('photoLenses', JSON.stringify(savedLenses));
                  // Update datalist to include the new lens
                  updateLensDatalist();
                } else {
                  delete savedLenses[imageLabel];
                  localStorage.setItem('photoLenses', JSON.stringify(savedLenses));
                  // Hide the item if lens is empty and not on localhost display mode
                  if (!isDev) {
                    metadataLensItem.style.display = 'none';
                  }
                }
                // Lens change handled - dropdown feature removed
              };

              // Also handle Enter key to immediately save and update
              metadataLensInput.onkeydown = (e: KeyboardEvent) => {
                if (e.key === 'Enter') {
                  e.preventDefault();
                  (metadataLensInput as HTMLInputElement).blur();
                  (metadataLensInput as HTMLInputElement).focus();
                }
              };

              // Lens Manager functionality
              const manageLensesBtn = document.getElementById('manageLensesBtn');
              const lensManagerModal = document.getElementById('lensManagerModal');
              const closeLensManager = document.getElementById('closeLensManager');
              const lensManagerList = document.getElementById('lensManagerList');

              function openLensManager() {
                if (!lensManagerModal || !lensManagerList) return;

                // Populate the list
                const lenses = getAllLenses();
                const savedLenses = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});

                lensManagerList.innerHTML = '';

                if (lenses.length === 0) {
                  lensManagerList.innerHTML = '<div class="lens-manager-empty">No lenses saved yet. Add lenses to photos to manage them here.</div>';
                } else {
                  lenses.forEach((lensItem: string) => {
                    // Count how many photos use this lens
                    const count = Object.values(savedLenses).filter((l: any) => l === lensItem).length;

                    const item = document.createElement('div');
                    item.className = 'lens-manager-item';
                    item.innerHTML = `
                      <input type="text" class="lens-manager-item-name readonly" value="${lensItem}" data-original="${lensItem}" readonly>
                      <span class="lens-manager-item-count">${count} photo${count !== 1 ? 's' : ''}</span>
                      <button class="lens-manager-btn edit" data-lens="${lensItem}">Edit</button>
                      <button class="lens-manager-btn delete" data-lens="${lensItem}">Delete</button>
                    `;

                    // Edit button handler
                    const editBtn = item.querySelector('.edit') as HTMLButtonElement;
                    const deleteBtn = item.querySelector('.delete') as HTMLButtonElement;
                    const nameInput = item.querySelector('.lens-manager-item-name') as HTMLInputElement;

                    editBtn.onclick = () => {
                      if (editBtn.textContent === 'Edit') {
                        // Enter edit mode
                        nameInput.readOnly = false;
                        nameInput.classList.remove('readonly');
                        nameInput.select();
                        editBtn.textContent = 'Save';
                        deleteBtn.disabled = true;
                      } else {
                        // Save changes
                        const oldLens = nameInput.dataset.original || '';
                        const newLens = nameInput.value.trim();

                        if (newLens && newLens !== oldLens) {
                          // Update all photos with this lens
                          const savedLenses = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});
                          Object.keys(savedLenses).forEach((label: string) => {
                            if (savedLenses[label] === oldLens) {
                              savedLenses[label] = newLens;
                            }
                          });
                          localStorage.setItem('photoLenses', JSON.stringify(savedLenses));

                          // Update current photo if it uses this lens
                          if ((metadataLensInput as HTMLInputElement).value === oldLens) {
                            (metadataLensInput as HTMLInputElement).value = newLens;
                          }

                          // Refresh the manager list
                          openLensManager();
                        } else {
                          // Cancel edit
                          nameInput.value = oldLens;
                          nameInput.readOnly = true;
                          nameInput.classList.add('readonly');
                          editBtn.textContent = 'Edit';
                          deleteBtn.disabled = false;
                        }
                      }
                    };

                    // Delete button handler
                    deleteBtn.onclick = () => {
                      const lensToDelete = nameInput.dataset.original || '';
                      if (confirm(`Delete "${lensToDelete}" from all photos?`)) {
                        const savedLenses = safeJSONParse<Record<string, string>>(localStorage.getItem('photoLenses'), {});
                        Object.keys(savedLenses).forEach((label: string) => {
                          if (savedLenses[label] === lensToDelete) {
                            delete savedLenses[label];
                          }
                        });
                        localStorage.setItem('photoLenses', JSON.stringify(savedLenses));

                        // Clear current photo if it uses this lens
                        if (metadataLensInput && (metadataLensInput as HTMLInputElement).value === lensToDelete) {
                          (metadataLensInput as HTMLInputElement).value = '';
                          if (metadataLensInput.onchange) {
                            (metadataLensInput.onchange as any)(new Event('change'));
                          }
                        }

                        // Refresh the manager list
                        openLensManager();
                      }
                    };

                    lensManagerList.appendChild(item);
                  });
                }

                lensManagerModal.style.display = 'flex';
              }

              if (manageLensesBtn) {
                manageLensesBtn.onclick = (e) => {
                  e.stopPropagation();
                  openLensManager();
                };
              }

              if (closeLensManager) {
                closeLensManager.onclick = () => {
                  if (lensManagerModal) lensManagerModal.style.display = 'none';
                };
              }

              if (lensManagerModal) {
                lensManagerModal.onclick = (e) => {
                  if (e.target === lensManagerModal) {
                    lensManagerModal.style.display = 'none';
                  }
                };
              }
            } else {
              // Not in development: show display only if lens exists
              metadataLensDisplay.style.display = 'inline';
              metadataLensDisplay.textContent = lens;
            }
          } else {
            // No lens and not localhost: hide completely
            metadataLensItem.style.display = 'none';
          }
        }


        // Handle description/notes section
        const descriptionSection = document.getElementById('descriptionSection');
        const descriptionTitle = document.getElementById('descriptionTitle');
        const descriptionCaption = document.getElementById('descriptionCaption');

        if (galleryItemData && galleryItemData.description && descriptionSection && descriptionTitle && descriptionCaption) {
          descriptionTitle.textContent = galleryItemData.description.title;
          descriptionCaption.textContent = galleryItemData.description.caption;
          descriptionSection.style.display = 'block';
        } else if (descriptionSection) {
          descriptionSection.style.display = 'none';
        }

        if (lightbox) {
          lightbox.classList.add('active');
        }
        // Fix body to prevent scrolling underneath
        document.body.classList.add('lightbox-open');
      }

      function closeLightbox() {
        if (lightbox) {
          lightbox.classList.remove('active');
        }
        // Release body scroll lock
        document.body.classList.remove('lightbox-open');
      }

      function navigateLightbox(direction: string) {
        devLog(`Navigate lightbox: ${direction}, current index: ${currentImageIndex}`);
        // Navigate to previous or next photo without looping
        if (direction === 'prev') {
          if (currentImageIndex > 0) {
            currentImageIndex = currentImageIndex - 1;
          } else {
            // At first photo, don't go back
            devLog('Already at first photo, not navigating');
            return;
          }
        } else if (direction === 'next') {
          if (currentImageIndex < visibleItems.length - 1) {
            currentImageIndex = currentImageIndex + 1;
          } else {
            // At last photo, don't go forward
            devLog('Already at last photo, not navigating');
            return;
          }
        }
        devLog(`New index: ${currentImageIndex}`);
        openLightbox(currentImageIndex);
      }

      // Event listeners
      galleryItems.forEach((item) => {
        item.addEventListener('click', () => {
          const visibleIndex = visibleItems.indexOf(item);
          if (visibleIndex !== -1) {
            openLightbox(visibleIndex);
          }
        });
      });

      if (lightboxClose) {
        lightboxClose.addEventListener('click', closeLightbox);
      }
      if (lightboxPrev) {
        lightboxPrev.addEventListener('click', (e) => {
          e.stopPropagation();
          devLog('Prev button clicked');
          navigateLightbox('prev');
        });
      }
      if (lightboxNext) {
        lightboxNext.addEventListener('click', (e) => {
          e.stopPropagation();
          devLog('Next button clicked');
          navigateLightbox('next');
        });
      }

      // Close lightbox on outside click
      if (lightbox) {
        lightbox.addEventListener('click', (e) => {
          if (e.target === lightbox) {
            closeLightbox();
          }
        });
      }

      // Category dropdown functionality
      if (categoryDropdownBtn && categoryDropdownMenu) {
        // Initialize dropdown with all available categories
        const initializeCategoryDropdown = () => {
          if (!categoryDropdownMenu) return;

          // Get all categories from the filter tabs
          const allCategories: string[] = [];
          filterTabs.forEach(tab => {
            const filterValue = tab.getAttribute('data-filter');
            if (filterValue && filterValue !== 'all') {
              allCategories.push(filterValue);
            }
          });

          // Populate dropdown with checkboxes for each category
          categoryDropdownMenu.innerHTML = '';
          allCategories.forEach(category => {
            const item = document.createElement('div');
            item.className = 'category-dropdown-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `category-${category}`;
            checkbox.value = category;

            const label = document.createElement('label');
            label.htmlFor = `category-${category}`;
            label.textContent = category.charAt(0).toUpperCase() + category.slice(1);

            item.appendChild(checkbox);
            item.appendChild(label);
            categoryDropdownMenu.appendChild(item);

            // Handle checkbox change
            checkbox.addEventListener('change', (e) => {
              const target = e.target as HTMLInputElement;
              const currentItem = visibleItems[currentImageIndex];
              if (!currentItem) return;

              const itemHref = currentItem.getAttribute('data-href');
              const galleryItemData = window.galleryData.find((item: any) => item.href === itemHref);

              if (galleryItemData) {
                // Initialize additionalCategories if it doesn't exist
                if (!galleryItemData.additionalCategories) {
                  galleryItemData.additionalCategories = [];
                }

                if (target.checked) {
                  // Add category if not already present and not the primary category
                  if (!galleryItemData.additionalCategories.includes(category) &&
                      galleryItemData.category !== category) {
                    galleryItemData.additionalCategories.push(category);
                  }
                } else {
                  // Remove category
                  const index = galleryItemData.additionalCategories.indexOf(category);
                  if (index > -1) {
                    galleryItemData.additionalCategories.splice(index, 1);
                  }
                }

                // Update the display
                updateCategoryDisplay(galleryItemData);

                devLog('Category updated:', {
                  primary: galleryItemData.category,
                  additional: galleryItemData.additionalCategories
                });
              }
            });
          });
        };

        // Function to update category display
        const updateCategoryDisplay = (galleryItemData: any) => {
          if (!categoryDisplay) return;

          const primaryCategory = galleryItemData.category || 'all';
          const additionalCategories = galleryItemData.additionalCategories || [];

          categoryDisplay.innerHTML = '';

          // Add primary category tag
          const primaryTag = document.createElement('span');
          primaryTag.className = 'category-tag';
          primaryTag.textContent = primaryCategory.charAt(0).toUpperCase() + primaryCategory.slice(1);
          categoryDisplay.appendChild(primaryTag);

          // Add additional category tags
          additionalCategories.forEach((cat: string) => {
            const tag = document.createElement('span');
            tag.className = 'category-tag';
            tag.textContent = cat.charAt(0).toUpperCase() + cat.slice(1);
            categoryDisplay.appendChild(tag);
          });
        };

        // Function to update checkboxes based on current photo's categories
        const updateCategoryCheckboxes = (galleryItemData: any) => {
          if (!categoryDropdownMenu) return;

          const primaryCategory = galleryItemData.category || 'all';
          const additionalCategories = galleryItemData.additionalCategories || [];

          // Update all checkboxes
          const checkboxes = categoryDropdownMenu.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach((checkbox: any) => {
            const category = checkbox.value;
            // Check if this category is either primary or in additional categories
            checkbox.checked = category === primaryCategory || additionalCategories.includes(category);
            // Disable primary category checkbox
            checkbox.disabled = category === primaryCategory;
          });
        };

        // Toggle dropdown on button click
        categoryDropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          categoryDropdownMenu?.classList.toggle('active');

          // Update checkboxes when opening
          if (categoryDropdownMenu?.classList.contains('active')) {
            const currentItem = visibleItems[currentImageIndex];
            if (currentItem) {
              const itemHref = currentItem.getAttribute('data-href');
              const galleryItemData = window.galleryData.find((item: any) => item.href === itemHref);
              if (galleryItemData) {
                updateCategoryCheckboxes(galleryItemData);
              }
            }
          }
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (categoryDropdownMenu?.classList.contains('active')) {
            const target = e.target as HTMLElement;
            if (!categoryDropdownMenu.contains(target) && target !== categoryDropdownBtn) {
              categoryDropdownMenu.classList.remove('active');
            }
          }
        });

        // Initialize dropdown
        initializeCategoryDropdown();
      }

      // Keyboard navigation
      document.addEventListener('keydown', (e) => {
        if (lightbox && lightbox.classList.contains('active')) {
          if (e.key === 'Escape') {
            closeLightbox();
          } else if (e.key === 'ArrowLeft') {
            navigateLightbox('prev');
          } else if (e.key === 'ArrowRight') {
            navigateLightbox('next');
          }
        }
      });

      // Hybrid shuffle: Smart distribution with Fisher-Yates randomization
      // Keeps similar file numbers far apart (priority) while adding random variation
      function smartShuffleByFileNumber(items: Element[]): Element[] {
        // Extract file numbers from labels
        function extractFileNumber(item: Element): number {
          const img = item.querySelector('img');
          const label = img?.alt || '';
          // Match common patterns like "IMG 8413", "DSC02870", "IMG_4127", "DSC 08799"
          const match = label.match(/(\d+)/);
          return match?.[1] ? parseInt(match[1], 10) : 0;
        }

        // Create array with file numbers
        const photosWithNumbers = items.map(item => ({
          item,
          fileNumber: extractFileNumber(item)
        }));

        // Sort by file number
        photosWithNumbers.sort((a, b) => a.fileNumber - b.fileNumber);

        // Add controlled randomness: shuffle within small adjacent groups
        // This maintains distance between similar numbers while adding variety
        const groupSize = Math.max(3, Math.floor(photosWithNumbers.length / 20));
        for (let i = 0; i < photosWithNumbers.length; i += groupSize) {
          const groupEnd = Math.min(i + groupSize, photosWithNumbers.length);
          const group = photosWithNumbers.slice(i, groupEnd);

          // Fisher-Yates shuffle within the small group
          for (let j = group.length - 1; j > 0; j--) {
            const k = Math.floor(Math.random() * (j + 1));
            [group[j]!, group[k]!] = [group[k]!, group[j]!];
          }

          // Put shuffled group back
          for (let j = 0; j < group.length; j++) {
            photosWithNumbers[i + j] = group[j]!;
          }
        }

        // Interleaved distribution algorithm with randomized step
        // This spreads out consecutive numbers maximally
        const result = new Array(items.length);
        const baseStep = Math.ceil(Math.sqrt(items.length));

        // Add random variation to starting position
        let resultIndex = Math.floor(Math.random() * Math.min(baseStep, items.length));
        let sourceIndex = 0;

        // First pass: distribute with randomized step size
        while (sourceIndex < photosWithNumbers.length) {
          if (resultIndex >= result.length) {
            // Wrap around and find next empty slot
            resultIndex = result.findIndex((item: any) => item === undefined);
            if (resultIndex === -1) break;
          }

          if (result[resultIndex] === undefined) {
            result[resultIndex] = photosWithNumbers[sourceIndex]!.item;
            sourceIndex++;
          }

          // Add random variation to step size (Â±20% of base step)
          const stepVariation = Math.floor(baseStep * 0.2);
          const randomizedStep = baseStep + Math.floor(Math.random() * (stepVariation * 2 + 1)) - stepVariation;
          resultIndex += Math.max(1, randomizedStep);
        }

        // Fill remaining gaps with Fisher-Yates-style random placement
        let remainingIndices = result
          .map((item, idx) => item === undefined ? idx : -1)
          .filter(idx => idx !== -1);

        while (remainingIndices.length > 0 && sourceIndex < photosWithNumbers.length) {
          // Randomly select from available positions
          const randomIdx = Math.floor(Math.random() * remainingIndices.length);
          const targetIdx = remainingIndices[randomIdx]!;

          result[targetIdx] = photosWithNumbers[sourceIndex]!.item;
          sourceIndex++;
          remainingIndices.splice(randomIdx, 1);
        }

        devLog('ðŸ”€ Hybrid shuffle applied:', items.length, 'photos (smart distribution + random variation)');
        devLog('   File number range:', photosWithNumbers[0]?.fileNumber, '-', photosWithNumbers[photosWithNumbers.length - 1]?.fileNumber);
        devLog('   Base step:', baseStep, '(with Â±20% random variation)');
        devLog('   Group shuffle size:', groupSize);

        const filteredResult = result.filter((item: any) => item !== undefined) as Element[];

        // Post-process: Create brickwork layout by distributing portraits optimally
        // Ensures vertical photos mix and match with horizontal/square photos
        function createBrickworkLayout(shuffled: Element[]): Element[] {
          const columnCount = window.innerWidth <= 768 ? 2 : 3; // Match CSS breakpoint

          function isPortrait(item: Element): boolean {
            const orientation = item.getAttribute('data-orientation');
            return orientation === 'portrait';
          }

          function isLandscape(item: Element): boolean {
            const orientation = item.getAttribute('data-orientation');
            return orientation === 'landscape' || orientation === 'square';
          }

          let swapCount = 0;

          // Strategy: Create alternating pattern for balanced brickwork
          // Pass 1: Break up consecutive portraits (no 2+ portraits side by side)
          for (let i = 0; i < shuffled.length - columnCount + 1; i++) {
            const consecutiveGroup = shuffled.slice(i, i + columnCount);
            const portraitCount = consecutiveGroup.filter(isPortrait).length;

            // If we have 2+ portraits in a row, redistribute
            if (portraitCount >= 2) {
              // Find the second portrait in the group
              let portraitsSeen = 0;
              for (let k = 0; k < consecutiveGroup.length; k++) {
                const groupItem = consecutiveGroup[k];
                if (groupItem && isPortrait(groupItem)) {
                  portraitsSeen++;
                  if (portraitsSeen >= 2) {
                    const swapIdx = i + k;
                    // Find a landscape photo further down to swap with
                    for (let j = i + columnCount; j < shuffled.length; j++) {
                      const targetItem = shuffled[j];
                      if (targetItem && isLandscape(targetItem)) {
                        [shuffled[swapIdx]!, shuffled[j]!] = [shuffled[j]!, shuffled[swapIdx]!];
                        swapCount++;
                        devLog(`ðŸ§± Brickwork swap: portrait at ${swapIdx} â†” landscape at ${j}`);
                        break;
                      }
                    }
                    break;
                  }
                }
              }
            }
          }

          // Pass 2: Ensure better vertical distribution (across columns)
          // Check every Nth position (same column) to avoid vertical stacking
          for (let col = 0; col < columnCount; col++) {
            let consecutivePortraitsInColumn = 0;
            for (let row = 0; row * columnCount + col < shuffled.length; row++) {
              const idx = row * columnCount + col;
              if (idx >= shuffled.length) break;

              const currentItem = shuffled[idx];
              if (currentItem && isPortrait(currentItem)) {
                consecutivePortraitsInColumn++;
                // If we have 2+ portraits vertically in the same column, swap one out
                if (consecutivePortraitsInColumn >= 2) {
                  // Find a landscape photo to swap with
                  for (let j = idx + 1; j < Math.min(idx + columnCount * 3, shuffled.length); j++) {
                    const swapItem = shuffled[j];
                    if (swapItem && isLandscape(swapItem)) {
                      [shuffled[idx]!, shuffled[j]!] = [shuffled[j]!, shuffled[idx]!];
                      swapCount++;
                      consecutivePortraitsInColumn = 0;
                      devLog(`ðŸ§± Vertical distribution: portrait at ${idx} â†” landscape at ${j}`);
                      break;
                    }
                  }
                }
              } else {
                consecutivePortraitsInColumn = 0;
              }
            }
          }

          devLog(`âœ… Brickwork layout created: ${swapCount} optimizations for balanced distribution`);
          return shuffled;
        }

        const finalResult = createBrickworkLayout(filteredResult);
        devLog('ðŸ§± Portrait distribution optimized for brickwork pattern');

        return finalResult;
      }

      function shuffleGallery() {
        devLog('Shuffling gallery...');

        // Get the gallery container
        const galleryGrid = document.querySelector('.gallery-grid');
        if (!galleryGrid) return;

        // Smart shuffle the visible items array to keep similar numbers far apart
        const shuffledItems = smartShuffleByFileNumber(visibleItems);

        // Re-append items to the DOM in the shuffled order
        shuffledItems.forEach((item) => {
          if (item.parentElement === galleryGrid) {
            galleryGrid.appendChild(item);
          }
        });

        // Update the visibleItems array to reflect the new order
        visibleItems = shuffledItems;

        // Add a subtle animation to show the shuffle happened
        shuffledItems.forEach((item, index) => {
          (item as HTMLElement).style.animation = 'none';
          (item as HTMLElement).offsetHeight; // Trigger reflow
          (item as HTMLElement).style.animation = `fadeInScale 0.4s ease-out ${index * 0.01}s`;
        });

        devLog('Gallery shuffled with', visibleItems.length, 'visible items');
      }

      // Shuffle button event listener
      const shuffleButton = document.getElementById('shuffleButton');
      if (shuffleButton) {
        shuffleButton.addEventListener('click', () => {
          // Add bubbling class for bubble animation
          shuffleButton.classList.add('bubbling');
          const circles = shuffleButton.querySelectorAll('circle');

          devLog('Shuffle clicked! Found', circles.length, 'circles');

          // First, clear any existing animations to allow re-triggering
          circles.forEach(circle => {
            const circleElement = circle as unknown as HTMLElement;
            circleElement.style.animation = 'none';
            circleElement.style.webkitAnimation = 'none';
          });

          // Force a reflow to restart the animation
          void shuffleButton.offsetWidth;

          // Apply random bubble animations to each circle
          circles.forEach((circle, index) => {
            const animationName = `bubble${(index % 7) + 1}`;
            const delay = Math.random() * 0.1;
            const duration = 0.8 + Math.random() * 0.2; // Full cycle duration

            const animationString = `${animationName} ${duration}s ease-in-out ${delay}s`;
            const circleElement = circle as unknown as HTMLElement;

            // Apply animation with webkit prefix for better mobile support
            circleElement.style.animation = animationString;
            circleElement.style.webkitAnimation = animationString;

            devLog(`Circle ${index}: applying animation "${animationString}"`);
          });

          // Trigger the shuffle
          shuffleGallery();

          // Remove bubbling class after animation completes
          setTimeout(() => {
            shuffleButton.classList.remove('bubbling');
            devLog('Bubble animation complete');
          }, 1100); // Time for animation to complete
        });
      }


      // Image protection helper function
      function protectImage(img: HTMLElement) {
        img.addEventListener('contextmenu', e => e.preventDefault());
        img.addEventListener('dragstart', e => e.preventDefault());
        img.style.userSelect = 'none';
        (img as any).style.webkitUserSelect = 'none';
        (img as any).style.mozUserSelect = 'none';
        (img as any).style.msUserSelect = 'none';
        (img as any).style.webkitTouchCallout = 'none';
        (img as any).style.webkitUserDrag = 'none';
        (img as any).style.khtmlUserDrag = 'none';
        (img as any).style.mozUserDrag = 'none';
        (img as any).style.oUserDrag = 'none';

        // Mobile protection
        img.addEventListener('touchstart', (e: any) => {
          if (e.touches && e.touches.length > 1) e.preventDefault();
        });
        img.addEventListener('touchmove', (e: any) => {
          if (e.touches && e.touches.length > 1) e.preventDefault();
        });

        // Prevent long press
        img.addEventListener('touchstart', (e) => {
          let timer = setTimeout(() => e.preventDefault(), 500);
          img.addEventListener('touchend', () => clearTimeout(timer), { once: true });
          img.addEventListener('touchmove', () => clearTimeout(timer), { once: true });
        });
      }

      // Apply image protection
      document.querySelectorAll('.gallery-item img').forEach(img => protectImage(img as HTMLElement));
      const lightboxImg = document.getElementById('lightboxImage');
      if (lightboxImg) protectImage(lightboxImg);

      // Additional global mobile security measures
      // Prevent zoom on double tap for gallery container
      const galleryGrid = document.querySelector('.gallery-grid');
      if (galleryGrid) {
        galleryGrid.addEventListener('touchstart', (e: any) => {
          if (e.touches && e.touches.length > 1) {
            e.preventDefault();
          }
        });
      }

      // Image protection - only prevent Ctrl+S to avoid interfering with legitimate browser functionality
      document.addEventListener('keydown', (e) => {
        // Prevent Ctrl+S, Ctrl+Shift+S (save) - basic image protection
        if ((e.ctrlKey || e.metaKey) && (e.key === 's' || e.key === 'S')) {
          e.preventDefault();
        }
      });

      // Mobile touch gesture support for lightbox navigation
      let touchStartX = 0;
      let touchEndX = 0;
      const minSwipeDistance = 50;

      function handleSwipeGesture() {
        const swipeDistance = touchEndX - touchStartX;
        if (Math.abs(swipeDistance) > minSwipeDistance) {
          if (swipeDistance > 0) {
            // Swipe right - previous image
            navigateLightbox('prev');
          } else {
            // Swipe left - next image
            navigateLightbox('next');
          }
        }
      }

      if (lightbox) {
        lightbox.addEventListener('touchstart', (e) => {
          if (lightbox.classList.contains('active')) {
            touchStartX = e.changedTouches[0]?.screenX || 0;
          }
        });

        lightbox.addEventListener('touchend', (e) => {
          if (lightbox.classList.contains('active')) {
            touchEndX = e.changedTouches[0]?.screenX || 0;
            handleSwipeGesture();
          }
        });
      }

      // Mobile viewport meta tag optimization
      const metaViewport = document.querySelector('meta[name="viewport"]');
      if (metaViewport) {
        metaViewport.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
      }

      // Advanced Performance Optimizations

      // 1. Critical Image Preloading with Progressive Enhancement (Mobile-Optimized)
      function preloadCriticalImages() {
        // Check device and connection before aggressive preloading
        const isMobile = window.innerWidth <= 768;
        const isSlowConnection = 'connection' in navigator &&
          (navigator.connection as any)?.effectiveType &&
          ['slow-2g', '2g', '3g'].includes((navigator.connection as any).effectiveType);

        // Reduce preloading on mobile and slow connections
        const maxPreload = isMobile || isSlowConnection ? 4 : 8;
        const selector = `.gallery-item:nth-child(-n+${maxPreload}) img[data-src]`;
        const firstRowImages = document.querySelectorAll(selector);

        firstRowImages.forEach((img, index) => {
          const src = (img as HTMLImageElement).dataset.src;
          if (src) {
            // Longer delays on mobile to avoid blocking main thread
            const delay = (isMobile || isSlowConnection) ? index * 200 : index * 50;
            setTimeout(() => {
              const preloadLink = document.createElement('link');
              preloadLink.rel = 'preload';
              preloadLink.as = 'image';
              preloadLink.href = src;
              preloadLink.setAttribute('fetchpriority', index < 2 ? 'high' : 'low');
              document.head.appendChild(preloadLink);
            }, delay);
          }
        });
      }

      // Enhanced Font Loading Optimization
      function optimizeFontLoading() {
        // Preload system fonts to eliminate layout shift
        const style = document.createElement('style');
        style.textContent = `
          @font-face {
            font-family: 'system-ui-fallback';
            src: local('system-ui'), local('-apple-system'), local('BlinkMacSystemFont');
            font-display: block;
          }
        `;
        document.head.appendChild(style);
      }

      // Helper function to observe new images (for filtering)
      function observeNewImages() {
        if (!imageObserver) return;

        const newLazyImages = document.querySelectorAll('img.lazy-load:not([data-observed])');
        newLazyImages.forEach(img => {
          imageObserver.observe(img);
          img.setAttribute('data-observed', 'true');
        });

        devLog('Observing', newLazyImages.length, 'new images');
      }

      // 3. Virtual Scrolling for Better Performance
      let visibleItemsSet = new Set();

      function optimizeVisibleItems() {
        // const scrollTop = window.pageYOffset;
        const windowHeight = window.innerHeight;
        const items = document.querySelectorAll('.gallery-item');

        items.forEach((item, index) => {
          const rect = (item as HTMLElement).getBoundingClientRect();
          const isInViewport = (
            rect.top < windowHeight + 200 &&
            rect.bottom > -200
          );

          if (isInViewport && !visibleItemsSet.has(index)) {
            visibleItemsSet.add(index);
            (item as HTMLElement).style.visibility = 'visible';
          } else if (!isInViewport && visibleItemsSet.has(index)) {
            visibleItemsSet.delete(index);
          }
        });
      }

      // 4. Debounced scroll optimization
      let scrollTimeout: ReturnType<typeof setTimeout>;
      function onOptimizedScroll() {
        clearTimeout(scrollTimeout);
        scrollTimeout = setTimeout(() => {
          optimizeVisibleItems();
        }, 16); // ~60fps
      }

      // Initialize performance optimizations
      optimizeFontLoading();
      preloadCriticalImages();

      // Add optimized scroll listener
      window.addEventListener('scroll', onOptimizedScroll, { passive: true });

      // 6. Prefetch next images on hover (Desktop-optimized)
      let prefetchTimeout: ReturnType<typeof setTimeout>;
      const isMobileDevice = window.innerWidth <= 768 || 'ontouchstart' in window;

      // Only enable hover prefetch on desktop with good connections
      if (!isMobileDevice) {
        const hasGoodConnection = !('connection' in navigator) ||
          !(navigator.connection as any)?.effectiveType ||
          !['slow-2g', '2g', '3g'].includes((navigator.connection as any).effectiveType);

        if (hasGoodConnection) {
          document.addEventListener('mouseover', (e) => {
            const galleryItem = (e.target as HTMLElement).closest('.gallery-item');
            if (galleryItem) {
              clearTimeout(prefetchTimeout);
              prefetchTimeout = setTimeout(() => {
                const nextItems = Array.from(document.querySelectorAll('.gallery-item')).slice(
                  Array.from(document.querySelectorAll('.gallery-item')).indexOf(galleryItem) + 1,
                  Array.from(document.querySelectorAll('.gallery-item')).indexOf(galleryItem) + 3
                );

                nextItems.forEach((item) => {
                  const img = item.querySelector('img[data-src]') as HTMLImageElement;
                  if (img && img.dataset.src) {
                    const preloadImg = new Image();
                    preloadImg.src = img.dataset.src;
                  }
                });
              }, 150);
            }
          });
        }
      }
    });
  </script>

  <!-- Consolidated optimized scripts -->
</Layout>